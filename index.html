<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ứng Dụng Chấm Công</title>
  <style>
    /* CSS Variables for theming */
    :root {
      --font-family: 'Segoe UI', system-ui, -apple-system, Roboto, "Helvetica Neue", Arial, sans-serif;
      --primary: #0ea5a4;
      --primary-hover: #0d9488;
      --danger: #e11d48;
      --danger-hover: #be123c;
      --bg-light: #f8fafc;
      --bg-dark: #0f172a;
      --surface-light: #ffffff;
      --surface-dark: #1e293b;
      --text-light: #0f172a;
      --text-dark: #f1f5f9;
      --text-muted-light: #64748b;
      --text-muted-dark: #94a3b8;
      --border-light: #e2e8f0;
      --border-dark: #334155;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --radius: 8px;
    }

    /* Base styles */
    * { box-sizing: border-box; }
    html { font-size: 16px; }
    body {
      margin: 0;
      font-family: var(--font-family);
      background: var(--bg-light);
      color: var(--text-light);
      transition: background 0.3s, color 0.3s;
    }

    /* Dark Mode */
    .dark body {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    .dark .card, .dark .card-section, .dark .modal {
      background: var(--surface-dark);
      border-color: var(--border-dark);
      color: var(--text-dark);
    }
    .dark input, .dark select, .dark textarea {
      background: var(--bg-dark);
      color: var(--text-dark);
      border-color: var(--border-dark);
    }
    .dark .btn-ghost { color: var(--text-dark); border-color: var(--border-dark); }
    .dark .btn-ghost:hover { background: rgba(255,255,255,0.05); }
    .dark th { background: #283446; }
    .dark tfoot td { background: var(--bg-dark); }
    .dark tbody tr:nth-child(even) { background: #1a2434; }
    .dark .muted-italic, .dark .muted, .dark .muted-sm, .dark .hint, .dark .note-small { color: var(--text-muted-dark); }
    .dark .highlight-total { background: #2a3b52 !important; }

    /* Layout */
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    .grid { display: grid; grid-template-columns: 1fr 420px; gap: 1.5rem; align-items: start; }
    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr; }
      .container { margin: 1rem auto; }
    }

    /* Components */
    h1,h2,h3 { margin: 0 0 1rem 0; font-weight: 700; color: inherit; }
    h1 { font-size: 1.75rem; }
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.25rem; }
    .card, .card-section {
      background: var(--surface-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
    }
    label { display: block; font-size: 0.875rem; margin-bottom: 0.375rem; font-weight: 500; color: var(--text-muted-light); }
    input[type="text"], input[type="password"], input[type="number"], select, input[type="date"], input[type="time"], textarea {
      width: 100%;
      padding: 0.625rem 0.75rem;
      border-radius: var(--radius);
      border: 1px solid var(--border-light);
      background: var(--surface-light);
      font-size: 1rem;
      margin-bottom: 1rem;
      transition: border-color .2s, box-shadow .2s;
    }
    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
    }
    button, .btn {
      padding: 0.625rem 1rem;
      border-radius: var(--radius);
      border: 0;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s, transform 0.1s;
    }
    button:active, .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: var(--danger-hover); }
    .btn-ghost { background: transparent; color: var(--text-light); border: 1px solid var(--border-light); }
    .btn-ghost:hover { background: color-mix(in srgb, var(--primary) 8%, transparent); border-color: color-mix(in srgb, var(--primary) 50%, transparent); }
    .btn-small { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
    .btn-icon { padding: 0.5rem; line-height: 0; }
    .big-btn { padding: 1rem; font-size: 1.25rem; font-weight: 700; }

    /* Login View */
    #loginView { display: flex; align-items: center; justify-content: center; min-height: 80vh; }
    #loginView .card { width: 100%; max-width: 420px; }

    /* App View: Navbar (fixed) */
    .navbar { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 0.75rem; border-radius: var(--radius); background: var(--surface-light); border:1px solid var(--border-light); box-shadow: var(--shadow); position: fixed; top: 12px; left: 50%; transform: translateX(-50%); width: calc(100% - 2rem); max-width: 1200px; z-index: 50; }
    /* Push app content below navbar */
    #appView { padding-top: 4.5rem; }

    .nav-left, .topbar-right { display: flex; align-items: center; gap: 1rem; }
    .tabs { display: flex; gap: 0.5rem; }
    .tab-btn { padding: 0.5rem 1rem; background: transparent; border: 0; font-weight: 600; color: var(--text-muted-light); }
    .tab-btn.active { color: var(--primary); box-shadow: 0 2px 0 var(--primary); border-radius: 4px 4px 0 0; }

    /* Dashboard */
    #statusText { font-weight: 500; font-size: 1.1rem; }
    .stats { margin-top: 1.5rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.9rem; }
    .stats > div { background: var(--bg-light); padding: 0.75rem; border-radius: var(--radius); }
    .dark .stats > div { background: var(--bg-dark); }
    .stats strong { display: block; font-size: 1.2rem; color: var(--primary); font-weight: 700; }
    #recentLogsContainer .log-item { display:flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: var(--radius); transition: background .2s; }
    #recentLogsContainer .log-item:hover { background: var(--bg-light); }
    .dark #recentLogsContainer .log-item:hover { background: var(--bg-dark); }

    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
    th, td { padding: 0.75rem; border-bottom: 1px solid var(--border-light); text-align: left; }
    th { background: var(--bg-light); font-weight: 600; color: var(--text-muted-light); text-transform: uppercase; font-size: 0.8rem; }
    tfoot td { font-weight: 700; font-size: 1rem; background: color-mix(in srgb, var(--primary) 8%, transparent); }
    tbody tr:nth-child(even) { background: var(--bg-light); }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(10, 10, 15, 0.6); display: none; align-items: center; justify-content: center; z-index: 60; backdrop-filter: blur(4px); }
    .modal { width: 100%; max-width: 520px; background: var(--surface-light); padding: 1.5rem; border-radius: var(--radius); box-shadow: 0 12px 40px rgba(11, 22, 50, 0.2); border: 1px solid var(--border-light); }

    /* Toast notifications */
    .toast-wrap { position: fixed; right: 1.5rem; bottom: 1.5rem; z-index: 90; display: flex; flex-direction: column; gap: 0.5rem; }
    .toast { background: color-mix(in srgb, var(--surface-dark) 95%, transparent); color: white; padding: 0.75rem 1rem; border-radius: var(--radius); box-shadow: var(--shadow); font-weight: 600; font-size: 0.9rem; opacity: 0; transform: translateY(8px); transition: all .2s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }

    /* Helpers */
    .flex-row { display: flex; gap: 0.5rem; }
    .flex-col { flex: 1; }
    .muted { color: var(--text-muted-light); }
    .muted-sm { color: var(--text-muted-light); font-size: 0.875rem; }
    .hint { font-size: 0.8rem; color: var(--text-muted-light); margin-top: -0.5rem; margin-bottom: 1rem; }
    .note-small { font-size: 0.8rem; color: var(--text-muted-light); margin-top: 0.25rem; }
    hr { margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-light); }
    .text-right { text-align: right; }
    .delete-icon { width: 16px; height: 16px; vertical-align: middle; }
  </style>
</head>
<body>
  <div class="container" id="appContainer">
    <div id="loginView">
      <div class="card" role="main" aria-labelledby="loginTitle">
        <h1 id="loginTitle">Đăng Nhập / Đăng Ký</h1>
        <p class="muted">Ứng Dụng Chấm Công Offline — dữ liệu lưu cục bộ trên trình duyệt.</p>
        <form id="loginForm">
          <label for="username">Tên đăng nhập</label>
          <input id="username" type="text" autocomplete="username" required placeholder="ví dụ: nguyen.bao" />
          <label for="password">Mật khẩu</label>
          <input id="password" type="password" autocomplete="current-password" required placeholder="••••••••" />
          <div style="display:flex;gap:10px;margin-top:6px;">
            <button class="btn-primary" type="submit">Đăng Nhập / Đăng Ký</button>
            <button class="btn-ghost" type="button" id="clearDataBtn" title="Xóa toàn bộ dữ liệu (cục bộ)">Xóa dữ liệu</button>
          </div>
          <p class="hint" style="margin-top:1rem;">Nếu tên người dùng chưa tồn tại, hệ thống sẽ tự tạo tài khoản mới.</p>
        </form>
      </div>
    </div>

    <div id="appView" style="display:none;">
      <nav class="navbar">
        <div class="nav-left">
          <div id="greeting" style="font-weight:600;">Xin chào!</div>
          <div class="tabs" role="tablist">
            <button class="tab-btn active" id="tabDashboardBtn">Dashboard</button>
            <button class="tab-btn" id="tabReportBtn">Báo Cáo</button>
            <button class="tab-btn" id="tabSettingsBtn">Cài Đặt</button>
          </div>
        </div>
        <div class="topbar-right">
          <div class="muted-sm" id="currentWageText">Lương: —</div>
          <label style="display:flex;align-items:center;gap:6px;font-size:0.9rem;cursor:pointer;">
            <input id="darkModeToggle" type="checkbox" /> Chế độ tối
          </label>
          <button class="btn-ghost" id="logoutBtn">Đăng Xuất</button>
        </div>
      </nav>

      <div id="tabsContent">
        <div id="dashboardTab">
          <div class="grid">
            <div class="card-section">
              <h2>Trạng thái chấm công</h2>
              <p id="statusText">Bạn chưa chấm công.</p>
              <div style="display:flex;gap:1rem;align-items:center;margin-top:1rem;">
                <button id="checkBtn" class="big-btn btn-primary">CHECK-IN</button>
                <div style="display:flex;flex-direction:column;gap:0.5rem;width:220px;">
                  <button id="backfillBtn" class="btn-ghost btn-small">Bù chấm công</button>
                  <button id="quickCheckBtn" class="btn-ghost btn-small" title="Check-in/out theo giờ Việt Nam hiện tại">Check Nhanh (giờ VN)</button>
                </div>
              </div>
              <div class="stats" id="quickStats">
                <div>Giờ hôm nay<strong id="todayHours">0 giờ</strong></div>
                <div>Giờ tuần này<strong id="weekHours">0 giờ</strong></div>
                <div>Giờ tháng này<strong id="monthHours">0 giờ</strong></div>
                <div>Thu nhập tháng<strong id="monthEarnings">0 VNĐ</strong></div>
                <div style="grid-column: span 2;">
                  Mục tiêu thu nhập tháng: <strong id="targetAmountDisplay" style="display:inline; color:inherit;">— VNĐ</strong>
                  (<span id="targetPercent" style="font-weight:bold;">—%</span>)
                </div>
              </div>
              <hr />
              <h3>Thêm ca làm thủ công</h3>
              <form id="manualLogForm">
                <label for="manualDate">Ngày</label>
                <input id="manualDate" type="date" required />
                <div class="flex-row">
                  <div class="flex-col">
                    <label for="manualStart">Giờ bắt đầu</label>
                    <input id="manualStart" type="time" required step="60" />
                  </div>
                  <div class="flex-col">
                    <label for="manualEnd">Giờ kết thúc</label>
                    <input id="manualEnd" type="time" required step="60" />
                  </div>
                </div>
                <p class="hint">Sử dụng định dạng 24 giờ. Ví dụ: 12:00 - 17:30</p>
                <label for="manualNote">Ghi chú (tuỳ chọn)</label>
                <input id="manualNote" type="text" placeholder="Ví dụ: Hoàn thành nhiệm vụ X" />
                <div style="margin-top:8px;display:flex;gap:8px;">
                  <button class="btn-primary" type="submit">Thêm ca</button>
                  <button class="btn-ghost" type="button" id="clearManual">Xóa</button>
                </div>
              </form>
            </div>

            <div class="card-section">
              <h3>Ca làm gần đây</h3>
              <div id="recentLogsContainer"></div>
            </div>
          </div>
        </div>

        <div id="reportTab" class="card-section" style="display:none;">
          <h2>Báo Cáo Chi Tiết</h2>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:1rem;">
            <label class="small" for="reportMonth">Tháng</label>
            <select id="reportMonth"></select>
            <label class="small" for="reportYear">Năm</label>
            <select id="reportYear"></select>
            <button class="btn-primary" id="refreshReportBtn">Xem báo cáo</button>
            <button class="btn-ghost" id="exportCsvBtn" title="Xuất CSV báo cáo">Xuất CSV</button>
            <button class="btn-ghost" id="exportXlsBtn" title="Xuất Excel (.xls)">Xuất Excel</button>
          </div>
          <div id="reportTableContainer"></div>
        </div>

        <div id="settingsTab" class="card-section" style="display:none;">
          <h2>Cài Đặt</h2>
          <p>Mức lương hiện tại: <strong id="currentWageDisplay">— VNĐ/giờ</strong></p>
          <form id="wageForm" style="max-width:420px;">
            <label for="newWage">Mức lương mới theo giờ (VNĐ)</label>
            <input id="newWage" type="number" min="0" required placeholder="Nhập mức lương mới" />
            <div class="flex-row">
              <button class="btn-primary" type="submit">Lưu thay đổi</button>
              <button class="btn-ghost" type="button" id="resetWageBtn">Đặt mặc định</button>
            </div>
            <p class="hint">Lưu ý: Mức lương mới chỉ áp dụng cho các ca làm việc sau khi lưu.</p>
          </form>
          <hr/>
          <h3>Mục tiêu tháng</h3>
           <div style="max-width:420px;">
             <label for="targetAmountInput">Mục tiêu thu nhập cuối tháng (VNĐ)</label>
             <input id="targetAmountInput" type="number" min="0" placeholder="Ví dụ: 4000000" />
             <div class="flex-row" style="margin-top:8px;">
               <button class="btn-primary" id="saveTargetBtn">Lưu mục tiêu</button>
               <button class="btn-ghost" id="clearTargetBtn">Xóa mục tiêu</button>
             </div>
             <p class="hint">Hiển thị % hoàn thành mục tiêu thu nhập trên Dashboard.</p>
           </div>
          <hr />
          <h3>Dữ liệu</h3>
          <div class="flex-row" style="flex-wrap:wrap;">
            <button class="btn-ghost" id="exportJsonBtn">Xuất JSON (Backup)</button>
            <label class="btn btn-ghost" for="importJsonFile">Nhập JSON (Restore)</label>
            <input id="importJsonFile" type="file" accept=".json,application/json" style="display:none;" />
            <button class="btn-danger" id="clearAllBtn">Xóa Toàn Bộ Dữ Liệu</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="backfillModal" class="modal-backdrop">
    <div class="modal">
      <h3>Bù chấm công</h3>
      <p class="muted-sm">Nhập ngày và giờ bạn muốn bù (định dạng 24 giờ).</p>
      <form id="backfillForm">
        <div class="flex-row">
          <div class="flex-col">
            <label>Ngày</label>
            <input id="backDate" type="date" required />
          </div>
          <div class="flex-col">
            <label>Giờ bắt đầu</label>
            <input id="backStart" type="time" required step="60" />
          </div>
        </div>
        <div class="flex-row" style="margin-top:8px;">
          <div class="flex-col">
            <label>Giờ kết thúc (bỏ trống nếu chỉ check-in)</label>
            <input id="backEnd" type="time" step="60" />
          </div>
        </div>
        <div class="flex-row" style="margin-top:1rem;">
          <button class="btn-primary" type="submit">Lưu</button>
          <button class="btn-ghost" id="cancelBackfill" type="button">Hủy</button>
        </div>
      </form>
    </div>
  </div>

  <div id="checkoutModal" class="modal-backdrop">
    <div class="modal">
      <h3>Ghi chú khi CHECK-OUT</h3>
      <form id="checkoutForm">
        <label for="checkoutNote">Ghi chú công việc hôm nay (tuỳ chọn)</label>
        <textarea id="checkoutNote" rows="4" placeholder="Mô tả ngắn những việc đã làm..."></textarea>
        <div class="flex-row" style="margin-top:12px;">
          <button class="btn-primary" type="submit">Lưu & CHECK-OUT</button>
          <button class="btn-ghost" id="cancelCheckout" type="button">Hủy</button>
        </div>
      </form>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <script>
    /*****************************************************************
     * Ứng Dụng Chấm Công Offline - Phiên bản đã chỉnh:
     * - Mục tiêu bằng tiền (VNĐ)
     * - Navbar fix-top
     * - Giờ chấm công dùng múi giờ VN (24h)
     *****************************************************************/

    const STORAGE_KEY = 'chamCongApp_v2';
    const DEFAULT_HOURLY_WAGE = 25000;
    const VN_TIMEZONE = 'Asia/Ho_Chi_Minh';

    let appData = null;

    // ---------- Utilities ----------
    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          appData = JSON.parse(raw);
          if (!appData.users) appData.users = {};
          if (!('currentUser' in appData)) appData.currentUser = null;
          if (!('settings' in appData)) appData.settings = { darkMode: false };
        } catch (e) {
          console.error('Lỗi khi đọc dữ liệu, tạo mới:', e);
          appData = { currentUser: null, users: {}, settings: { darkMode: false } };
        }
      } else {
        appData = { currentUser: null, users: {}, settings: { darkMode: false } };
      }
      // Ensure logs have unique IDs and migrate old targetHoursPerMonth -> targetEarningsPerMonth if present
      if (appData.users) {
          for (const user in appData.users) {
              const u = appData.users[user];
              if(!u.timeLogs) u.timeLogs = [];
              u.timeLogs.forEach(log => {
                  if (!log.id) {
                      log.id = Date.parse(log.checkInTime) || Date.now();
                  }
              });
              // Migration: if user used old targetHoursPerMonth, convert to monetary target using current hourlyWage
              if (u.targetHoursPerMonth && !u.targetEarningsPerMonth) {
                  const wage = (typeof u.hourlyWage === 'number' && u.hourlyWage > 0) ? u.hourlyWage : DEFAULT_HOURLY_WAGE;
                  u.targetEarningsPerMonth = Math.round(u.targetHoursPerMonth * wage);
                  delete u.targetHoursPerMonth;
              }
              if (!('targetEarningsPerMonth' in u)) u.targetEarningsPerMonth = null;
              if (!('hourlyWage' in u)) u.hourlyWage = DEFAULT_HOURLY_WAGE;
          }
      }
    }
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }
    function formatCurrency(v) {
      if (!isFinite(v)) return '0 VNĐ';
      return Math.round(v).toLocaleString('vi-VN') + ' VNĐ';
    }
    function formatDateTimeLocal(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      return isNaN(d) ? '-' : d.toLocaleString('vi-VN', { hour12: false, timeZone: VN_TIMEZONE });
    }
    function formatDateLocal(iso) {
      const d = new Date(iso);
      return isNaN(d) ? '-' : d.toLocaleDateString('vi-VN', { timeZone: VN_TIMEZONE });
    }
    function hoursBetween(startIso, endIso) {
      const s = new Date(startIso);
      const e = new Date(endIso);
      if (isNaN(s) || isNaN(e)) return 0;
      const hours = (e - s) / (1000 * 60 * 60);
      return Math.max(0, Math.round(hours * 100) / 100);
    }
    // Convert a local VN date + time (YYYY-MM-DD, HH:MM) to ISO string in UTC (Z)
    function makeIsoFromVnLocal(dateStr, timeStr) {
      const [y, m, d] = dateStr.split('-').map(Number);
      const [hh, mm] = (timeStr || '00:00').split(':').map(Number);
      // VN = UTC+7 -> to get UTC timestamp subtract 7 hours
      const utcMs = Date.UTC(y, m - 1, d, hh, mm, 0) - (7 * 60 * 60 * 1000);
      return new Date(utcMs).toISOString();
    }
    // Current time in VN as ISO (Z)
    function nowInVNIso() {
      // Create date string in VN timezone, then convert to ISO Z
      const parts = new Date().toLocaleString('en-CA', { timeZone: VN_TIMEZONE, hour12: false }).replace(', ', 'T');
      return parts + 'Z';
    }
    function getVNYearMonthFromIso(iso) {
      const d = new Date(new Date(iso).toLocaleString('en-US', { timeZone: VN_TIMEZONE }));
      return { year: d.getFullYear(), month: d.getMonth() };
    }
    function getVNDateParts(iso) {
      const d = new Date(new Date(iso).toLocaleString('en-US', { timeZone: VN_TIMEZONE }));
      return { year: d.getFullYear(), month: d.getMonth(), date: d.getDate(), dow: d.getDay() };
    }
    function getCurrentUserName() { return appData?.currentUser; }
    function getUserData(username) { return username && appData.users[username] ? appData.users[username] : null; }

    // ---------- Toast ----------
    function showToast(text, timeout = 3000) {
      const wrap = document.getElementById('toastWrap');
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = text;
      wrap.appendChild(t);
      requestAnimationFrame(() => t.classList.add('show'));
      setTimeout(() => {
        t.classList.remove('show');
        setTimeout(() => wrap.removeChild(t), 300);
      }, timeout);
    }

    // ---------- UI management ----------
    function showView(viewId) {
      ['loginView', 'appView'].forEach(id => {
        document.getElementById(id).style.display = (id === viewId) ? '' : 'none';
      });
    }
    function showTab(tabId) {
      ['dashboardTab', 'reportTab', 'settingsTab'].forEach(id => {
        document.getElementById(id).style.display = (id === tabId) ? '' : 'none';
      });
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      if (tabId === 'dashboardTab') document.getElementById('tabDashboardBtn').classList.add('active');
      if (tabId === 'reportTab') document.getElementById('tabReportBtn').classList.add('active');
      if (tabId === 'settingsTab') document.getElementById('tabSettingsBtn').classList.add('active');
    }

    function updateUI() {
      const current = getCurrentUserName();
      if (!current) {
        showView('loginView');
        return;
      }
      showView('appView');
      document.getElementById('greeting').textContent = `Xin chào, ${current}!`;
      const ud = getUserData(current);
      document.getElementById('currentWageText').textContent = `Lương: ${formatCurrency(ud.hourlyWage).replace(' VNĐ', '')}/giờ`;
      document.getElementById('currentWageDisplay').textContent = `${formatCurrency(ud.hourlyWage)}`;

      const lastLog = ud.timeLogs.length ? ud.timeLogs[ud.timeLogs.length - 1] : null;
      const isCheckedIn = lastLog && !lastLog.checkOutTime;
      const checkBtn = document.getElementById('checkBtn');
      const statusText = document.getElementById('statusText');
      if (isCheckedIn) {
        checkBtn.textContent = 'CHECK-OUT';
        checkBtn.className = 'big-btn btn-danger';
        statusText.innerHTML = `✅ Đang trong ca làm việc (từ ${formatDateTimeLocal(lastLog.checkInTime)})`;
      } else {
        checkBtn.textContent = 'CHECK-IN';
        checkBtn.className = 'big-btn btn-primary';
        statusText.textContent = `❌ Bạn chưa check-in.`;
      }

      const nowISO = nowInVNIso();
      const nowVN = getVNDateParts(nowISO);
      const todayHours = calcHoursForDay(ud.timeLogs, nowVN.year, nowVN.month, nowVN.date);
      document.getElementById('todayHours').textContent = `${todayHours} giờ`;
      const weekHours = calcHoursForWeek(ud.timeLogs, nowISO);
      document.getElementById('weekHours').textContent = `${weekHours} giờ`;
      const { totalHours, totalEarnings } = calcMonthStats(ud.timeLogs, nowVN.month, nowVN.year);
      document.getElementById('monthHours').textContent = `${totalHours} giờ`;
      document.getElementById('monthEarnings').textContent = formatCurrency(totalEarnings);

      const target = ud.targetEarningsPerMonth;
      document.getElementById('targetAmountDisplay').textContent = target ? `${formatCurrency(target)}` : '— VNĐ';
      document.getElementById('targetPercent').textContent = (target && totalEarnings > 0) ? `${Math.round((totalEarnings / target) * 100)}%` : '—%';

      renderRecentLogs(ud.timeLogs);
      populateReportPeriodSelector();
      applyDarkMode(appData.settings.darkMode);
      saveData();
    }
    
    // ---------- Delete Log ----------
    function handleDeleteLog(logId) {
        if (!logId) return;
        if (!confirm('Bạn có chắc chắn muốn xóa chấm công này không? Dữ liệu không thể phục hồi.')) return;

        const username = getCurrentUserName();
        const ud = getUserData(username);
        if (!ud || !ud.timeLogs) return;

        const logIndex = ud.timeLogs.findIndex(log => log.id == logId);

        if (logIndex > -1) {
            ud.timeLogs.splice(logIndex, 1);
            saveData();
            showToast('Đã xóa chấm công.');
            updateUI();
            if (document.getElementById('reportTab').style.display !== 'none') {
                document.getElementById('refreshReportBtn').click();
            }
        } else {
            showToast('Lỗi: Không tìm thấy chấm công để xóa.', 4000);
        }
    }

    // ---------- Rendering ----------
    function renderRecentLogs(timeLogs) {
      const container = document.getElementById('recentLogsContainer');
      container.innerHTML = '';
      if (!timeLogs || !timeLogs.length) {
        container.innerHTML = '<p class="muted-sm">Chưa có ca làm nào.</p>';
        return;
      }
      const ul = document.createElement('div');
      ul.style.display = 'flex';
      ul.style.flexDirection = 'column';
      ul.style.gap = '0.5rem';
      
      const trashSVG = `<svg class="delete-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1h-11z"/></svg>`;

      timeLogs.slice().reverse().slice(0, 15).forEach(log => {
        const item = document.createElement('div');
        item.className = 'log-item';
        const date = formatDateLocal(log.checkInTime);
        const inT = formatDateTimeLocal(log.checkInTime).split(' ')[1];
        const outT = log.checkOutTime ? formatDateTimeLocal(log.checkOutTime).split(' ')[1] : '<span class="muted-sm">Đang làm</span>';
        const hours = log.checkOutTime ? `${hoursBetween(log.checkInTime, log.checkOutTime)} giờ` : '-';
        const earn = log.earnings ? formatCurrency(log.earnings) : '-';
        const note = log.note ? `<div class="note-small">📝 ${escapeHtml(log.note)}</div>` : '';
        
        item.innerHTML = `
          <div style="flex-grow:1;">
            <div style="font-weight:600;">${date} <span class="muted-sm">(${inT} → ${outT})</span></div>
            ${note}
          </div>
          <div style="text-align:right; min-width:100px; margin-right: 0.5rem;">
            <div>${hours}</div>
            <div class="muted-sm">${earn}</div>
          </div>
          <button class="btn-danger btn-icon btn-delete-log" data-log-id="${log.id}" title="Xóa chấm công">${trashSVG}</button>
        `;
        ul.appendChild(item);
      });
      container.appendChild(ul);
    }
    
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }
    
    // --- Calculations ---
    function calcMonthStats(timeLogs, monthZeroBased, year) {
        let totalHours = 0, totalEarnings = 0;
        (timeLogs || []).forEach(log => {
            if (!log.checkOutTime) return;
            const parts = getVNYearMonthFromIso(log.checkInTime);
            if (parts.month === monthZeroBased && parts.year === year) {
                const h = hoursBetween(log.checkInTime, log.checkOutTime);
                totalHours += h;
                totalEarnings += log.earnings || 0;
            }
        });
        return { totalHours: Math.round(totalHours * 100) / 100, totalEarnings };
    }
    function calcHoursForDay(timeLogs, year, monthZeroBased, date) {
        let total = 0;
        (timeLogs || []).forEach(log => {
            const p = getVNDateParts(log.checkInTime);
            if (!p || p.year !== year || p.month !== monthZeroBased || p.date !== date) return;
            const endTime = log.checkOutTime || nowInVNIso();
            total += hoursBetween(log.checkInTime, endTime);
        });
        return Math.round(total * 100) / 100;
    }
    function calcHoursForWeek(timeLogs, referenceIso) {
        const refDate = new Date(new Date(referenceIso).toLocaleString('en-US', { timeZone: VN_TIMEZONE }));
        const dayOfWeek = refDate.getDay(); // 0 = Sunday
        const offset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        const monday = new Date(refDate);
        monday.setDate(refDate.getDate() + offset);
        monday.setHours(0, 0, 0, 0);

        let sum = 0;
        for (let i = 0; i < 7; i++) {
            const day = new Date(monday);
            day.setDate(monday.getDate() + i);
            sum += calcHoursForDay(timeLogs, day.getFullYear(), day.getMonth(), day.getDate());
        }
        return Math.round(sum * 100) / 100;
    }
    
    // ---------- Event Listeners and App Logic ----------
    document.addEventListener('DOMContentLoaded', () => {
        loadData();

        // Global delete listener
        document.getElementById('appContainer').addEventListener('click', function(event) {
            const target = event.target.closest('.btn-delete-log');
            if (target) {
                handleDeleteLog(target.dataset.logId);
            }
        });
        
        const loginForm = document.getElementById('loginForm');
        loginForm.addEventListener('submit', handleLoginRegister);

        document.getElementById('clearDataBtn').addEventListener('click', () => {
            if (confirm('BẠN CÓ CHẮC MUỐN XÓA TOÀN BỘ DỮ LIỆU? Hành động này không thể hoàn tác.')) {
                localStorage.removeItem(STORAGE_KEY);
                appData = { currentUser: null, users: {}, settings: { darkMode: false } };
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showToast('Đã xóa toàn bộ dữ liệu.');
                updateUI();
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', logout);
        
        // Tabs
        document.getElementById('tabDashboardBtn').addEventListener('click', () => showTab('dashboardTab'));
        document.getElementById('tabReportBtn').addEventListener('click', () => { showTab('reportTab'); document.getElementById('refreshReportBtn').click(); });
        document.getElementById('tabSettingsBtn').addEventListener('click', () => showTab('settingsTab'));

        // Check-in/out
        document.getElementById('checkBtn').addEventListener('click', handleCheckInOut);
        document.getElementById('quickCheckBtn').addEventListener('click', () => handleCheckInOut(true));

        // Manual log
        document.getElementById('manualLogForm').addEventListener('submit', handleManualLog);
        document.getElementById('clearManual').addEventListener('click', () => document.getElementById('manualLogForm').reset());
        
        // Backfill
        const backfillModal = document.getElementById('backfillModal');
        document.getElementById('backfillBtn').addEventListener('click', () => backfillModal.style.display = 'flex');
        document.getElementById('cancelBackfill').addEventListener('click', () => backfillModal.style.display = 'none');
        document.getElementById('backfillForm').addEventListener('submit', handleBackfill);

        // Checkout Note
        const checkoutModal = document.getElementById('checkoutModal');
        document.getElementById('cancelCheckout').addEventListener('click', () => checkoutModal.style.display = 'none');
        document.getElementById('checkoutForm').addEventListener('submit', handleCheckoutNoteSubmit);

        // Report
        document.getElementById('refreshReportBtn').addEventListener('click', renderReportTable);
        
        // Settings
        document.getElementById('wageForm').addEventListener('submit', handleWageUpdate);
        document.getElementById('resetWageBtn').addEventListener('click', () => {
            document.getElementById('newWage').value = DEFAULT_HOURLY_WAGE;
            handleWageUpdate({ preventDefault: () => {} });
        });
        document.getElementById('saveTargetBtn').addEventListener('click', saveTargetAmount);
        document.getElementById('clearTargetBtn').addEventListener('click', clearTargetAmount);
        
        // Dark Mode
        const darkModeToggle = document.getElementById('darkModeToggle');
        darkModeToggle.checked = appData.settings.darkMode;
        darkModeToggle.addEventListener('change', (e) => {
            appData.settings.darkMode = e.target.checked;
            applyDarkMode(e.target.checked);
            saveData();
        });
        
        // Data export/import
        document.getElementById('exportJsonBtn').addEventListener('click', exportJson);
        document.getElementById('importJsonFile').addEventListener('change', importJson);
        document.getElementById('clearAllBtn').addEventListener('click', () => document.getElementById('clearDataBtn').click());
        document.getElementById('exportCsvBtn').addEventListener('click', () => exportReport('csv'));
        document.getElementById('exportXlsBtn').addEventListener('click', () => exportReport('xls'));


        if (appData.currentUser && appData.users[appData.currentUser]) {
            updateUI();
        } else {
            showView('loginView');
        }
    });
    
    function applyDarkMode(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
    }

    // --- Authentication ---
    function handleLoginRegister(evt) {
        evt.preventDefault();
        const username = document.getElementById('username').value.trim().toLowerCase();
        const password = document.getElementById('password').value;
        if (!username) return alert('Vui lòng nhập tên đăng nhập.');
        if (appData.users[username]) {
            if (appData.users[username].password === password) {
                appData.currentUser = username;
                showToast(`Chào mừng trở lại, ${username}!`);
                updateUI();
            } else {
                alert('Mật khẩu không đúng.');
            }
        } else {
            if (!confirm(`Tài khoản "${username}" không tồn tại. Bạn có muốn tạo mới không?`)) return;
            appData.users[username] = { password: password, hourlyWage: DEFAULT_HOURLY_WAGE, timeLogs: [], targetEarningsPerMonth: null };
            appData.currentUser = username;
            showToast('Tạo tài khoản mới thành công!');
            updateUI();
        }
        document.getElementById('password').value = '';
    }

    function logout() {
        if (!confirm('Bạn có chắc muốn đăng xuất?')) return;
        appData.currentUser = null;
        saveData();
        updateUI();
    }
    
    // --- Core Actions ---
    function handleCheckInOut(isQuick = false) {
        const username = getCurrentUserName();
        const ud = getUserData(username);
        const lastLog = ud.timeLogs.length ? ud.timeLogs[ud.timeLogs.length - 1] : null;
        const isCheckedIn = lastLog && !lastLog.checkOutTime;

        if (isCheckedIn) { // Checking out
            if (isQuick) {
                handleCheckoutNoteSubmit({ preventDefault: () => {} }, true); // Quick checkout without note
            } else {
                document.getElementById('checkoutModal').style.display = 'flex';
                document.getElementById('checkoutNote').focus();
            }
        } else { // Checking in
            const newLog = {
                id: Date.now(),
                checkInTime: nowInVNIso(),
                checkOutTime: null,
                earnings: null,
                note: null
            };
            ud.timeLogs.push(newLog);
            showToast('CHECK-IN thành công!');
            updateUI();
        }
    }

    function handleCheckoutNoteSubmit(evt, skipNote = false) {
        evt.preventDefault();
        const username = getCurrentUserName();
        const ud = getUserData(username);
        const lastLog = ud.timeLogs[ud.timeLogs.length - 1];
        lastLog.checkOutTime = nowInVNIso();
        if (!skipNote) {
            lastLog.note = document.getElementById('checkoutNote').value.trim();
        }
        lastLog.earnings = Math.round(hoursBetween(lastLog.checkInTime, lastLog.checkOutTime) * ud.hourlyWage);
        document.getElementById('checkoutModal').style.display = 'none';
        document.getElementById('checkoutForm').reset();
        showToast('CHECK-OUT thành công!');
        updateUI();
    }

    function handleManualLog(evt) {
        evt.preventDefault();
        const date = document.getElementById('manualDate').value;
        const start = document.getElementById('manualStart').value;
        const end = document.getElementById('manualEnd').value;
        if (!date || !start || !end) return alert('Vui lòng nhập đầy đủ ngày giờ.');
        // Ensure 24h order
        if (start >= end) {
            return alert('Giờ kết thúc phải sau giờ bắt đầu.');
        }
        const note = document.getElementById('manualNote').value.trim();
        const startISO = makeIsoFromVnLocal(date, start);
        const endISO = makeIsoFromVnLocal(date, end);

        const username = getCurrentUserName();
        const ud = getUserData(username);
        const earnings = Math.round(hoursBetween(startISO, endISO) * ud.hourlyWage);
        const newLog = { id: Date.now(), checkInTime: startISO, checkOutTime: endISO, earnings, note };
        
        ud.timeLogs.push(newLog);
        ud.timeLogs.sort((a, b) => new Date(a.checkInTime) - new Date(b.checkInTime));
        showToast('Đã thêm ca làm thủ công.');
        evt.target.reset();
        updateUI();
    }
    
    function handleBackfill(evt) {
        evt.preventDefault();
        const date = document.getElementById('backDate').value;
        const start = document.getElementById('backStart').value;
        const end = document.getElementById('backEnd').value;

        if (!date || !start) return alert('Vui lòng nhập ngày và giờ bắt đầu.');
        if (end && start >= end) {
            return alert('Giờ kết thúc phải sau giờ bắt đầu.');
        }

        const startISO = makeIsoFromVnLocal(date, start);
        const endISO = end ? makeIsoFromVnLocal(date, end) : null;
        
        const username = getCurrentUserName();
        const ud = getUserData(username);
        const earnings = endISO ? Math.round(hoursBetween(startISO, endISO) * ud.hourlyWage) : null;
        
        const newLog = { id: Date.now(), checkInTime: startISO, checkOutTime: endISO, earnings, note: 'Ca bù' };
        
        ud.timeLogs.push(newLog);
        ud.timeLogs.sort((a, b) => new Date(a.checkInTime) - new Date(b.checkInTime));

        showToast('Đã bù chấm công thành công.');
        document.getElementById('backfillForm').reset();
        document.getElementById('backfillModal').style.display = 'none';
        updateUI();
    }
    
    // --- Settings Logic ---
    function handleWageUpdate(evt) {
        evt.preventDefault();
        const newWage = parseFloat(document.getElementById('newWage').value);
        if (isNaN(newWage) || newWage < 0) return alert('Mức lương không hợp lệ.');
        
        const username = getCurrentUserName();
        getUserData(username).hourlyWage = newWage;
        showToast('Đã cập nhật mức lương.');
        updateUI();
    }

    function saveTargetAmount() {
        const target = parseFloat(document.getElementById('targetAmountInput').value);
        if (isNaN(target) || target <= 0) {
            alert('Vui lòng nhập mục tiêu tiền hợp lệ (số lớn hơn 0).');
            return;
        }
        const ud = getUserData(getCurrentUserName());
        ud.targetEarningsPerMonth = Math.round(target);
        saveData();
        showToast('Đã lưu mục tiêu thu nhập tháng.');
        updateUI();
    }

    function clearTargetAmount() {
        const ud = getUserData(getCurrentUserName());
        ud.targetEarningsPerMonth = null;
        document.getElementById('targetAmountInput').value = '';
        saveData();
        showToast('Đã xóa mục tiêu tháng.');
        updateUI();
    }

    // --- Report Logic ---
    function populateReportPeriodSelector() {
        const username = getCurrentUserName();
        const logs = getUserData(username)?.timeLogs || [];
        const monthSelect = document.getElementById('reportMonth');
        const yearSelect = document.getElementById('reportYear');
        
        const availablePeriods = new Set();
        logs.forEach(log => {
            const { year, month } = getVNYearMonthFromIso(log.checkInTime);
            if (year && month !== null) {
                availablePeriods.add(`${year}-${String(month + 1).padStart(2, '0')}`);
            }
        });
        
        const sortedPeriods = Array.from(availablePeriods).sort().reverse();
        
        const currentYear = new Date().getFullYear();
        const years = new Set(sortedPeriods.map(p => p.split('-')[0]));
        for (let y = currentYear; y > currentYear - 5; y--) years.add(y.toString());

        yearSelect.innerHTML = Array.from(years).sort((a,b) => b-a).map(y => `<option value="${y}">${y}</option>`).join('');
        monthSelect.innerHTML = Array.from({length: 12}, (_, i) => `<option value="${i}">Tháng ${i + 1}</option>`).join('');

        const nowVN = getVNYearMonthFromIso(new Date().toISOString());
        monthSelect.value = nowVN.month;
        yearSelect.value = nowVN.year;
    }

    function renderReportTable() {
        const container = document.getElementById('reportTableContainer');
        const month = parseInt(document.getElementById('reportMonth').value);
        const year = parseInt(document.getElementById('reportYear').value);
        const ud = getUserData(getCurrentUserName());
        const logs = ud.timeLogs.filter(log => {
            const parts = getVNYearMonthFromIso(log.checkInTime);
            return parts.year === year && parts.month === month;
        });

        if (logs.length === 0) {
            container.innerHTML = '<p class="muted">Không có dữ liệu cho tháng đã chọn.</p>';
            return;
        }
        
        const trashSVG = `<svg class="delete-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1h-11z"/></svg>`;
        let totalHours = 0, totalEarnings = 0;
        let tableHTML = `
            <table>
                <thead><tr><th>Ngày</th><th>Check-in</th><th>Check-out</th><th>Số giờ</th><th>Thu nhập</th><th>Ghi chú</th><th>Thao tác</th></tr></thead>
                <tbody>`;
        logs.forEach(log => {
            const hours = log.checkOutTime ? hoursBetween(log.checkInTime, log.checkOutTime) : 0;
            const earnings = log.earnings || 0;
            totalHours += hours;
            totalEarnings += earnings;
            tableHTML += `
                <tr>
                    <td>${formatDateLocal(log.checkInTime)}</td>
                    <td>${formatDateTimeLocal(log.checkInTime)}</td>
                    <td>${log.checkOutTime ? formatDateTimeLocal(log.checkOutTime) : '-'}</td>
                    <td>${hours.toFixed(2)}</td>
                    <td>${formatCurrency(earnings)}</td>
                    <td>${log.note ? escapeHtml(log.note) : ''}</td>
                    <td><button class="btn-danger btn-icon btn-delete-log" data-log-id="${log.id}" title="Xóa">${trashSVG}</button></td>
                </tr>
            `;
        });
        tableHTML += `</tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-right"><strong>Tổng cộng</strong></td>
                    <td><strong>${totalHours.toFixed(2)} giờ</strong></td>
                    <td colspan="3"><strong>${formatCurrency(totalEarnings)}</strong></td>
                </tr>
            </tfoot>
        </table>`;
        container.innerHTML = tableHTML;
    }
    
    // --- Data Management (Export/Import) ---
    function exportJson() {
        const username = getCurrentUserName();
        if (!username) return;
        const dataStr = JSON.stringify({ [username]: getUserData(username) }, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cham-cong-backup-${username}-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Đã xuất file backup JSON.');
    }
    
    function importJson(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                const username = Object.keys(data)[0];
                if (!username || !data[username].timeLogs) {
                    throw new Error('Invalid file format');
                }
                if (confirm(`Bạn có chắc muốn nhập dữ liệu cho người dùng "${username}"? Dữ liệu hiện tại của người dùng này sẽ bị ghi đè.`)) {
                    appData.users[username] = data[username];
                    if (!appData.currentUser) appData.currentUser = username;
                    saveData();
                    showToast('Nhập dữ liệu thành công!');
                    updateUI();
                }
            } catch (err) {
                alert('Lỗi: File JSON không hợp lệ hoặc không đúng định dạng.');
                console.error(err);
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    }
    
    function exportReport(format) {
        const month = parseInt(document.getElementById('reportMonth').value);
        const year = parseInt(document.getElementById('reportYear').value);
        const ud = getUserData(getCurrentUserName());
        const logs = ud.timeLogs.filter(log => {
            const parts = getVNYearMonthFromIso(log.checkInTime);
            return parts.year === year && parts.month === month;
        });

        if (logs.length === 0) {
            return alert('Không có dữ liệu để xuất.');
        }

        const headers = ["Ngày", "Check-in", "Check-out", "Số giờ", "Thu nhập (VND)", "Ghi chú"];
        const rows = logs.map(log => {
            const hours = log.checkOutTime ? hoursBetween(log.checkInTime, log.checkOutTime) : 0;
            const earnings = log.earnings || 0;
            return [
                formatDateLocal(log.checkInTime),
                formatDateTimeLocal(log.checkInTime),
                log.checkOutTime ? formatDateTimeLocal(log.checkOutTime) : '',
                hours.toFixed(2),
                earnings,
                log.note || ''
            ];
        });

        let content = headers.join(',') + '\n';
        rows.forEach(row => {
            content += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
        });

        const blob = new Blob([content], { type: `text/${format};charset=utf-8;` });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bao-cao-cham-cong-${getCurrentUserName()}-${year}-${month+1}.${format}`;
        a.click();
        URL.revokeObjectURL(url);
    }

  </script>
</body>
</html>
