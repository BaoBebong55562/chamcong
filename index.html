<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ứng Dụng Chấm Công</title>
  <style>
    :root {
      --primary: #2a7ade;
      --primary-600: #1f5fb0;
      --accent: #22c55e;
      --danger: #ef4444;
      --bg: #f6f8fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --border: #e2e8f0;
      --shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      --radius: 12px;
    }
    [data-theme="dark"] {
      --primary: #60a5fa;
      --primary-600: #3b82f6;
      --accent: #22c55e;
      --danger: #ef4444;
      --bg: #0b1220;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: #1f2940;
      --shadow: 0 8px 24px rgba(0,0,0,0.45);
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    a { color: var(--primary); text-decoration: none; }
    .container { max-width: 1100px; margin: 96px auto 48px; padding: 0 16px; }
    .center { text-align: center; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }
    .grid { display: grid; gap: 16px; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    @media (max-width: 900px) { .grid-3 { grid-template-columns: 1fr; } }
    @media (max-width: 720px) { .grid-2 { grid-template-columns: 1fr; } }

    /* Navbar fixed */
    .navbar {
      position: fixed; top:0; left:0; right:0; z-index: 10;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
    }
    .nav-inner {
      max-width: 1100px; margin: 0 auto; padding: 12px 16px;
      display: flex; align-items: center; gap: 12px; justify-content: space-between;
    }
    .brand { font-weight: 700; color: var(--primary); letter-spacing: .3px; }
    .nav-left, .nav-right { display: flex; align-items: center; gap: 8px; }
    .tabs button {
      padding: 10px 14px; border-radius: 999px; border: 1px solid var(--border);
      background: transparent; color: var(--text); cursor: pointer;
    }
    .tabs button.active { background: var(--primary); border-color: var(--primary); color: white; }
    .greeting { color: var(--muted); margin-right: 8px; }

    /* Inputs & Buttons */
    .row { display: flex; flex-wrap: wrap; gap: 12px; }
    .field { flex: 1; min-width: 200px; }
    .field label { display:block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    .input, select, textarea {
      width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border);
      background: transparent; color: var(--text);
    }
    textarea { min-height: 80px; resize: vertical; }
    .btn {
      padding: 12px 16px; border-radius: 10px; border: 1px solid transparent; cursor: pointer;
      background: var(--primary); color: #fff; box-shadow: var(--shadow);
      transition: transform .03s ease-in-out;
    }
    .btn:active { transform: translateY(1px); }
    .btn-outline { background: transparent; color: var(--primary); border-color: var(--primary); }
    .btn-green { background: var(--accent); }
    .btn-red { background: var(--danger); }
    .btn-muted { background: #e5e7eb; color: #111827; border: 1px solid #cbd5e1; }
    [data-theme="dark"] .btn-muted { background: #1f2937; color: #e5e7eb; border-color: #334155; }

    /* Status */
    .status {
      display: flex; align-items: center; gap: 10px; padding: 12px 14px; border-radius: 12px;
      background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.25);
      color: var(--text);
    }
    .status.off {
      background: rgba(239, 68, 68, 0.08); border-color: rgba(239, 68, 68, 0.22);
    }

    /* Stats */
    .stat {
      padding: 16px; border: 1px solid var(--border); border-radius: 12px; background: var(--card);
    }
    .stat .label { color: var(--muted); font-size: 13px; }
    .stat .value { font-size: 22px; font-weight: 700; margin-top: 6px; }

    /* Table */
    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 12px; }
    thead { background: rgba(42,122,222,0.08); }
    thead th { text-align: left; padding: 12px; font-weight: 700; color: var(--text); border-bottom: 1px solid var(--border); }
    tbody td { padding: 12px; border-bottom: 1px solid var(--border); }
    tbody tr:nth-child(odd) { background: rgba(148,163,184,0.06); }
    tfoot td { padding: 14px; font-weight: 800; background: rgba(34, 197, 94, 0.12); border-top: 2px solid var(--border); }
    .table-actions { display: flex; gap: 8px; }
    .icon-col { width: 36px; text-align: center; opacity: .7; }

    /* Toast */
    .toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}
.toast .item {
  background: var(--card);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  padding: 16px 20px;
  border-radius: 12px;
  min-width: 280px;
  text-align: center;
  font-weight: 600;
}

    /* Progress bar */
    .progress {
      background: rgba(42,122,222,0.15); border-radius: 999px; height: 12px; overflow: hidden; border: 1px solid var(--border);
    }
    .progress > span {
      display: block; height: 100%; background: var(--primary); width: 0%;
      transition: width .3s ease;
    }

    /* Alert reminder */
    .reminder {
      padding: 12px 14px; border: 1px dashed var(--danger); color: var(--text);
      background: rgba(239, 68, 68, 0.08); border-radius: 12px;
    }

    /* Login screen */
    .login-wrap { max-width: 420px; margin: 0 auto; }
    .title { font-size: 26px; font-weight: 800; margin: 8px 0 18px; }
    .subtitle { color: var(--muted); margin-bottom: 16px; }
    .spacer { height: 8px; }

    /* Small text */
    .muted { color: var(--muted); font-size: 13px; }

    /* Canvas wrap */
    .canvas-wrap { width: 100%; overflow-x: auto; padding-bottom: 6px; }
    canvas { max-width: 100%; border: 1px solid var(--border); border-radius: 8px; background: var(--card); }

    /* Switch */
    .switch {
      position: relative; display: inline-block; width: 46px; height: 26px;
    }
    .switch input { display:none; }
    .slider {
      position: absolute; cursor: pointer; top:0; left:0; right:0; bottom:0;
      background-color:#cbd5e1; transition:.2s; border-radius: 999px;
    }
    .slider:before {
      position: absolute; content:""; height: 20px; width: 20px; left:3px; bottom:3px;
      background:white; transition:.2s; border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(20px); }
    /* Responsive container */
.container {
  max-width: 1100px;
  margin: 96px auto 48px;
  padding: 0 16px;
}
@media (max-width: 768px) {
  .grid-3 { grid-template-columns: 1fr; }
  .grid-2 { grid-template-columns: 1fr; }
  .nav-inner { flex-direction: column; align-items: flex-start; gap: 12px; }
  .tabs { display: flex; flex-wrap: wrap; gap: 6px; }
  .btn, .input { font-size: 15px; padding: 10px 12px; }
}
  </style>
</head>
<body>

  <!-- Navbar (shown after login) -->
  <div class="navbar" id="navbar" style="display:none;">
    <div class="nav-inner">
      <div class="nav-left">
        <div class="brand">Chấm Công Offline</div>
        <div class="greeting" id="greeting">Xin chào</div>
        <div class="tabs">
          <button id="tabDashboardBtn" class="active">Dashboard</button>
          <button id="tabReportBtn">Báo Cáo</button>
          <button id="tabSettingsBtn">Cài Đặt</button>
        </div>
      </div>
      <div class="nav-right">
        <div class="row" style="align-items:center;">
          <div class="muted">Dark mode</div>
          <label class="switch">
            <input type="checkbox" id="darkToggle" />
            <span class="slider"></span>
          </label>
        </div>
        <button class="btn btn-outline" id="logoutBtn">Đăng Xuất</button>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- LOGIN VIEW -->
    <div id="loginView">
      <div class="login-wrap card">
        <div class="title center">Đăng Nhập hoặc Đăng Ký</div>
        <div class="subtitle center">Chọn tên người dùng và mật khẩu đơn giản để bắt đầu</div>
        <div class="grid">
          <div class="field">
            <label for="loginUsername">Tên người dùng</label>
            <input id="loginUsername" class="input" placeholder="vd: gia" autocomplete="username"/>
          </div>
          <div class="field">
            <label for="loginPassword">Mật khẩu</label>
            <input id="loginPassword" type="password" class="input" placeholder="mật khẩu đơn giản" autocomplete="current-password"/>
          </div>
          <div class="field">
            <button class="btn" id="loginBtn">Đăng Nhập / Đăng Ký</button>
          </div>
          <div class="muted">Lưu ý: chỉ phân chia dữ liệu — không có bảo mật.</div>
        </div>
      </div>
    </div>

    <!-- APP VIEW -->
    <div id="appView" style="display:none;">
      <!-- Reminder -->
      <div id="reminderBar" class="reminder card" style="display:none; margin-bottom:16px;"></div>

      <!-- DASHBOARD TAB -->
      <div id="dashboardTab">
        <div class="grid grid-3">
          <div class="card">
            <div id="statusBox" class="status off">❌ Bạn chưa check-in</div>
            <div class="spacer"></div>
            <div class="row">
              <button class="btn btn-green" id="checkInBtn">CHECK-IN</button>
              <button class="btn btn-red" id="checkOutBtn" style="display:none;">CHECK-OUT</button>
            </div>
            <div id="checkoutNoteWrap" style="display:none; margin-top:12px;">
              <div class="field">
                <label for="checkoutNote">Ghi chú công việc hôm nay</label>
                <textarea id="checkoutNote" class="input" placeholder="Ví dụ: Hoàn thành module báo cáo, fix 3 bug..."></textarea>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="grid">
              <div class="stat">
                <div class="label">Tổng thu nhập tháng này</div>
                <div class="value" id="monthEarnings">0 VNĐ</div>
              </div>
              <div class="stat">
                <div class="label">Giờ đã làm hôm nay</div>
                <div class="value" id="todayHours">0 giờ</div>
              </div>
              <div class="stat">
                <div class="label">Tổng giờ tuần này / tháng này</div>
                <div class="value" id="weekMonthHours">0h / 0h</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="label" style="font-weight:700; margin-bottom:6px;">Mục tiêu thu nhập tháng</div>
            <div class="row" style="align-items:flex-end;">
              <div class="field">
                <label>Mục tiêu (VNĐ)</label>
                <input id="targetIncome" class="input" placeholder="vd: 1600000"/>
              </div>
              <button id="saveTargetBtn" class="btn btn-outline">Lưu mục tiêu</button>
            </div>
            <div class="spacer"></div>
            <div class="progress"><span id="targetProgress"></span></div>
            <div class="muted" id="targetLabel" style="margin-top:8px;">0% đạt được</div>
          </div>
        </div>

        <div class="spacer"></div>
        <div class="grid grid-2">
          <div class="card">
            <div style="font-weight:800; margin-bottom:8px;">Thêm ca làm thủ công</div>
            <div class="row">
              <div class="field">
                <label>Ngày</label>
                <input id="manualDate" class="input" type="date"/>
              </div>
              <div class="field">
                <label>Giờ bắt đầu</label>
                <input id="manualStart" class="input" type="time" step="60"/>
              </div>
              <div class="field">
                <label>Giờ kết thúc</label>
                <input id="manualEnd" class="input" type="time" step="60"/>
              </div>
            </div>
            <div class="field" style="margin-top:8px;">
              <label>Ghi chú</label>
              <input id="manualNote" class="input" placeholder="Ghi chú cho ca làm"/>
            </div>
            <div class="spacer"></div>
            <button class="btn" id="addManualBtn">Thêm</button>
          </div>

          <div class="card">
            <div style="font-weight:800; margin-bottom:8px;">Ca gần đây</div>
            <div id="recentLogs"></div>
          </div>
        </div>
      </div>

      <!-- REPORT TAB -->
      <div id="reportTab" style="display:none;">
        <div class="card">
          <div class="row">
            <div class="field">
              <label>Tháng</label>
              <select id="reportMonth" class="input"></select>
            </div>
            <div class="field">
              <label>Năm</label>
              <select id="reportYear" class="input"></select>
            </div>
            <div class="field" style="display:flex; gap:8px; align-items:flex-end;">
              <button class="btn btn-outline" id="refreshReportBtn">Xem báo cáo</button>
              <button class="btn btn-muted" id="exportCsvBtn">Xuất CSV</button>
            </div>
            <div class="field" style="display:flex; gap:8px; align-items:flex-end;">
              <button class="btn btn-muted" id="backupBtn">Backup JSON</button>
              <label class="btn btn-outline" style="cursor:pointer;">
                Nhập JSON
                <input type="file" id="restoreInput" accept="application/json" style="display:none;">
              </label>
            </div>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="grid">
          <div class="card">
            <div style="font-weight:800; margin-bottom:8px;">Báo cáo chi tiết</div>
            <div class="canvas-wrap" style="margin-bottom:12px;">
              <canvas id="reportChart" height="180"></canvas>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="icon-col">#</th>
                    <th>Ngày</th>
                    <th>⏰ Check-in</th>
                    <th>⏰ Check-out</th>
                    <th>⏱️ Số giờ</th>
                    <th>💰 Lương</th>
                    <th>Ghi chú</th>
                    <th>Thao tác</th>
                  </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
                <tfoot>
                  <tr>
                    <td colspan="4">Tổng cộng</td>
                    <td id="reportTotalHours">0 giờ</td>
                    <td id="reportTotalPay">0 VNĐ</td>
                    <td colspan="2"></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="settingsTab" style="display:none;">
        <div class="grid grid-2">
          <div class="card">
            <div class="label">Mức lương hiện tại</div>
            <div class="value" id="currentWage" style="font-weight:800; font-size:22px; color: var(--primary); margin-top:6px;">0 VNĐ/giờ</div>
            <div class="spacer"></div>
            <div class="row">
              <div class="field">
                <label>Mức lương mới theo giờ (VNĐ)</label>
                <input id="newWage" class="input" placeholder="Nhập mức lương mới theo giờ"/>
              </div>
              <button class="btn" id="saveWageBtn">Lưu thay đổi</button>
            </div>
          </div>

          <div class="card">
            <div style="font-weight:800; margin-bottom:8px;">Tùy chọn</div>
            <div class="grid">
              <div class="row" style="align-items:center; justify-content:space-between;">
                <div>
                  <div style="font-weight:600;">Nhắc nhở check-in/out</div>
                  <div class="muted">Hiện cảnh báo khi quên thao tác</div>
                </div>
                <label class="switch">
                  <input type="checkbox" id="reminderToggle">
                  <span class="slider"></span>
                </label>
              </div>
              <div class="row" style="align-items:center; justify-content:space-between;">
                <div>
                  <div style="font-weight:600;">Cho phép chỉnh sửa thời gian</div>
                  <div class="muted">Bật/tắt khả năng sửa ca làm</div>
                </div>
                <label class="switch">
                  <input type="checkbox" id="editToggle" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ====== Storage Key and Bootstrap ======
    const STORAGE_KEY = 'chamCongApp';

    // ====== State ======
    let appData = null; // loaded from localStorage
    let activeTab = 'dashboardTab';

    // ====== Utils ======
    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          appData = JSON.parse(raw);
        } catch {
          appData = { currentUser: null, users: {} };
        }
      } else {
        appData = { currentUser: null, users: {} };
      }
    }
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }
    function nowISO() { return new Date().toISOString(); }
    function uniqueId() { return String(Date.now()) + '_' + Math.random().toString(36).slice(2,8); }
    function fmtMoney(n) {
      if (!isFinite(n)) return '0 VNĐ';
      return n.toLocaleString('vi-VN') + ' VNĐ';
    }
    function fmtHour(n) {
      // n in hours (float)
      const h = Math.floor(n);
      const m = Math.round((n - h) * 60);
      if (m === 60) { return (h+1) + 'h 0m'; }
      return (h > 0 ? h + 'h ' : '') + m + 'm';
    }
    function parseVNInt(val) {
      if (typeof val === 'number') return val;
      if (!val) return 0;
      const cleaned = String(val).replace(/[^\d\-]/g, '');
      return parseInt(cleaned || '0', 10);
    }
    function pad2(n){ return n.toString().padStart(2,'0'); }
    function toDateObj(iso) { return new Date(iso); }
    function ymd(d) { return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate()); }
    function hm(d) { return pad2(d.getHours()) + ':' + pad2(d.getMinutes()); }
    function displayDate(iso) {
      const d = toDateObj(iso);
      return pad2(d.getDate()) + '/' + pad2(d.getMonth()+1) + '/' + d.getFullYear();
    }
    function displayDT(iso) {
      const d = toDateObj(iso);
      return displayDate(iso) + ' ' + hm(d);
    }
    function hoursBetween(isoStart, isoEnd) {
      const s = toDateObj(isoStart).getTime();
      const e = toDateObj(isoEnd).getTime();
      if (!isFinite(s) || !isFinite(e) || e <= s) return 0;
      return (e - s) / 3600000; // hours
    }
    function startOfWeek(d) {
      const x = new Date(d);
      const day = (x.getDay() + 6) % 7; // Mon=0
      x.setHours(0,0,0,0);
      x.setDate(x.getDate() - day);
      return x;
    }
    function endOfWeek(d) {
      const s = startOfWeek(d);
      const e = new Date(s);
      e.setDate(e.getDate() + 7);
      return e;
    }
    function startOfMonth(d) {
      return new Date(d.getFullYear(), d.getMonth(), 1);
    }
    function endOfMonth(d) {
      return new Date(d.getFullYear(), d.getMonth()+1, 1);
    }
    function showToast(msg) {
      const t = document.getElementById('toast');
      const item = document.createElement('div');
      item.className = 'item';
      item.textContent = msg;
      t.appendChild(item);
      setTimeout(() => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(6px)';
      }, 2400);
      setTimeout(() => t.removeChild(item), 2800);
    }

    function getUser() {
      const u = appData.currentUser;
      if (!u) return null;
      if (!appData.users[u]) appData.users[u] = { password:'', hourlyWage: 0, timeLogs: [] };
      return appData.users[u];
    }

    // ====== View Controls ======
    function showView(viewId) {
      document.getElementById('loginView').style.display = (viewId === 'loginView') ? 'block' : 'none';
      document.getElementById('appView').style.display = (viewId === 'appView') ? 'block' : 'none';
      document.getElementById('navbar').style.display = (viewId === 'appView') ? 'block' : 'none';
    }
    function showTab(tabId) {
      activeTab = tabId;
      ['dashboardTab', 'reportTab', 'settingsTab'].forEach(id => {
        document.getElementById(id).style.display = (id === tabId) ? 'block' : 'none';
      });
      // Tab button active
      document.getElementById('tabDashboardBtn').classList.toggle('active', tabId === 'dashboardTab');
      document.getElementById('tabReportBtn').classList.toggle('active', tabId === 'reportTab');
      document.getElementById('tabSettingsBtn').classList.toggle('active', tabId === 'settingsTab');

      if (tabId === 'reportTab') generateReport();
      if (tabId === 'dashboardTab') renderRecent();
    }

    // ====== Auth ======
    function handleLoginRegister() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!username) { showToast('Vui lòng nhập tên người dùng'); return; }
      if (!password) { showToast('Vui lòng nhập mật khẩu'); return; }

      const exists = !!appData.users[username];
      if (exists) {
        if (appData.users[username].password === password) {
          appData.currentUser = username;
          saveData();
          showToast('Đăng nhập thành công');
          updateUI();
        } else {
          showToast('Sai mật khẩu');
        }
      } else {
        appData.users[username] = {
          password,
          hourlyWage: 25000,
          timeLogs: [],
          settings: { reminders: true, allowEdit: true, dark: false, targetIncome: 0 }
        };
        appData.currentUser = username;
        saveData();
        showToast('Tạo tài khoản mới thành công');
        updateUI();
      }
    }
    function logout() {
      appData.currentUser = null;
      saveData();
      updateUI();
    }

    // ====== Core features ======
    function getActiveLog(user) {
      // active if log has checkInTime but no checkOutTime
      return (user.timeLogs || []).find(x => x.checkInTime && !x.checkOutTime);
    }

    function checkIn() {
      const user = getUser();
      if (!user) return;
      if (getActiveLog(user)) { showToast('Bạn đang trong ca làm'); return; }
      const rec = {
        id: uniqueId(),
        checkInTime: nowISO(),
        checkOutTime: null,
        earnings: 0,
        note: ''
      };
      user.timeLogs.unshift(rec);
      saveData();
      showToast('Đã CHECK-IN');
      updateUI();
    }

    function checkOut() {
      const user = getUser();
      if (!user) return;
      const rec = getActiveLog(user);
      if (!rec) { showToast('Bạn chưa CHECK-IN'); return; }
      rec.checkOutTime = nowISO();
      const hours = hoursBetween(rec.checkInTime, rec.checkOutTime);
      const wage = user.hourlyWage || 0;
      rec.earnings = Math.round(hours * wage);
      const note = document.getElementById('checkoutNote').value.trim();
      if (note) rec.note = note;
      saveData();
      showToast('Đã CHECK-OUT');
      document.getElementById('checkoutNote').value = '';
      updateUI();
    }

    function addManualLog() {
      const user = getUser();
      if (!user) return;
      const date = document.getElementById('manualDate').value;
      const start = document.getElementById('manualStart').value;
      const end = document.getElementById('manualEnd').value;
      const note = document.getElementById('manualNote').value.trim();

      if (!date || !start || !end) { showToast('Vui lòng nhập đủ ngày, giờ bắt đầu và kết thúc'); return; }
      const sISO = new Date(date + 'T' + start + ':00').toISOString();
      const eISO = new Date(date + 'T' + end + ':00').toISOString();
      const hrs = hoursBetween(sISO, eISO);
      if (hrs <= 0) { showToast('Giờ kết thúc phải sau giờ bắt đầu'); return; }

      const rec = {
        id: uniqueId(),
        checkInTime: sISO,
        checkOutTime: eISO,
        earnings: Math.round(hrs * (user.hourlyWage || 0)),
        note: note || ''
      };
      user.timeLogs.unshift(rec);
      saveData();
      showToast('Đã thêm ca thủ công');
      document.getElementById('manualNote').value = '';
      updateUI();
    }

    function updateWage() {
      const user = getUser();
      if (!user) return;
      const nw = parseVNInt(document.getElementById('newWage').value);
      if (nw <= 0) { showToast('Mức lương phải lớn hơn 0'); return; }
      user.hourlyWage = nw;
      saveData();
      showToast('Đã cập nhật mức lương');
      updateUI();
    }

    // Edit & Delete logs
    function deleteLog(logId) {
      const user = getUser();
      if (!user) return;
      user.timeLogs = (user.timeLogs || []).filter(x => x.id !== logId);
      saveData();
      showToast('Đã xóa ca làm');
      updateUI();
    }

    function updateLog(logId, newStartISO, newEndISO, newNote) {
      const user = getUser();
      if (!user) return;
      const rec = user.timeLogs.find(x => x.id === logId);
      if (!rec) return;
      if (newStartISO) rec.checkInTime = newStartISO;
      rec.checkOutTime = newEndISO || null;
      const hrs = (rec.checkOutTime) ? hoursBetween(rec.checkInTime, rec.checkOutTime) : 0;
      rec.earnings = Math.round(hrs * (user.hourlyWage || 0));
      rec.note = newNote || '';
      saveData();
      showToast('Đã cập nhật ca làm');
      updateUI();
    }

    // ====== Reporting ======
    function generateReport() {
      const user = getUser();
      if (!user) return;

      const monthSel = document.getElementById('reportMonth').value;
      const yearSel = parseInt(document.getElementById('reportYear').value, 10);

      const m = parseInt(monthSel, 10); // 1..12
      const start = new Date(yearSel, m - 1, 1);
      const end = new Date(yearSel, m, 1);

      const logs = (user.timeLogs || []).filter(x => {
        const ci = toDateObj(x.checkInTime);
        return ci >= start && ci < end && x.checkOutTime;
      }).sort((a,b) => toDateObj(a.checkInTime) - toDateObj(b.checkInTime));

      // Render table
      const tbody = document.getElementById('reportTableBody');
      tbody.innerHTML = '';
      let totalHours = 0, totalPay = 0;

      logs.forEach((x, idx) => {
        const h = hoursBetween(x.checkInTime, x.checkOutTime);
        totalHours += h;
        totalPay += (x.earnings || 0);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="icon-col">${idx + 1}</td>
          <td>${displayDate(x.checkInTime)}</td>
          <td>${hm(toDateObj(x.checkInTime))}</td>
          <td>${hm(toDateObj(x.checkOutTime))}</td>
          <td>${h.toFixed(2)}</td>
          <td>${fmtMoney(x.earnings || 0)}</td>
          <td>${(x.note || '').replace(/</g,'&lt;')}</td>
          <td>
            <div class="table-actions">
              <button class="btn btn-outline" data-edit="${x.id}">Sửa</button>
              <button class="btn btn-red" data-del="${x.id}">Xóa</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('reportTotalHours').textContent = totalHours.toFixed(2) + ' giờ';
      document.getElementById('reportTotalPay').textContent = fmtMoney(totalPay);

      // Bind actions for edit/delete in table
      tbody.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', () => deleteLog(btn.getAttribute('data-del')));
      });
      tbody.querySelectorAll('button[data-edit]').forEach(btn => {
        btn.addEventListener('click', () => openEditPrompt(btn.getAttribute('data-edit')));
      });

      // Chart: hours per day of month
      renderMonthChart(start, logs);
    }

    function renderMonthChart(monthStart, logs) {
      const canvas = document.getElementById('reportChart');
      const ctx = canvas.getContext('2d');

      const year = monthStart.getFullYear();
      const month = monthStart.getMonth(); // 0..11
      const lastDay = new Date(year, month + 1, 0).getDate();

      const perDay = Array(lastDay).fill(0);
      logs.forEach(x => {
        const d = toDateObj(x.checkInTime);
        const dayIdx = d.getDate() - 1;
        const h = hoursBetween(x.checkInTime, x.checkOutTime);
        perDay[dayIdx] += h;
      });

      // Clear
      ctx.clearRect(0,0,canvas.width, canvas.height);
      const W = canvas.width = canvas.clientWidth || 800;
      const H = canvas.height;

      const padding = 32;
      const chartW = W - padding*2;
      const chartH = H - padding*2;
      const maxVal = Math.max(1, Math.ceil(Math.max(...perDay) || 0));
      const barW = Math.max(3, chartW / lastDay - 4);

      // Axes
      ctx.strokeStyle = '#94a3b8';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding, H - padding);
      ctx.lineTo(W - padding, H - padding);
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, H - padding);
      ctx.stroke();

      // Y labels
      ctx.fillStyle = '#94a3b8';
      ctx.font = '12px system-ui';
      for (let t = 0; t <= maxVal; t += Math.max(1, Math.round(maxVal/4))) {
        const y = H - padding - (t / maxVal) * chartH;
        ctx.fillText(String(t) + 'h', 4, y + 4);
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(148,163,184,0.3)';
        ctx.moveTo(padding, y);
        ctx.lineTo(W - padding, y);
        ctx.stroke();
      }

      // Bars
      const baseX = padding;
      const step = chartW / lastDay;
      for (let i=0;i<lastDay;i++) {
        const v = perDay[i];
        const h = (v / maxVal) * chartH;
        const x = baseX + i * step + 2;
        const y = H - padding - h;

        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#2a7ade';
        ctx.fillRect(x, y, barW, h);

        // day label every 2 days
        if (i % 2 === 0) {
          ctx.fillStyle = '#94a3b8';
          ctx.fillText(String(i+1), x, H - padding + 12);
        }
      }
    }

    // ====== Dashboard rendering ======
    function computeStats() {
      const user = getUser();
      const logs = (user?.timeLogs || []);

      const today = new Date();
      const todayYMD = ymd(today);

      let todayHours = 0;
      let weekHours = 0;
      let monthHours = 0;
      let monthEarnings = 0;

      const sw = startOfWeek(today);
      const ew = endOfWeek(today);
      const sm = startOfMonth(today);
      const em = endOfMonth(today);

      logs.forEach(x => {
        const ci = toDateObj(x.checkInTime);
        const co = x.checkOutTime ? toDateObj(x.checkOutTime) : null;
        const h = co ? hoursBetween(x.checkInTime, x.checkOutTime) : 0;

        if (ymd(ci) === todayYMD && h > 0) todayHours += h;
        if (ci >= sw && ci < ew && h > 0) weekHours += h;
        if (ci >= sm && ci < em && h > 0) {
          monthHours += h;
          monthEarnings += (x.earnings || 0);
        }
      });

      // If currently checked-in, add live hours to today/week/month
      const active = getActiveLog(user);
      if (active) {
        const liveH = hoursBetween(active.checkInTime, nowISO());
        const aci = toDateObj(active.checkInTime);
        if (ymd(aci) === todayYMD) todayHours += liveH;
        if (aci >= sw && aci < ew) weekHours += liveH;
        if (aci >= sm && aci < em) monthHours += liveH;
      }

      return { todayHours, weekHours, monthHours, monthEarnings };
    }

    function renderStatus() {
      const user = getUser();
      const statusBox = document.getElementById('statusBox');
      const checkInBtn = document.getElementById('checkInBtn');
      const checkOutBtn = document.getElementById('checkOutBtn');
      const noteWrap = document.getElementById('checkoutNoteWrap');

      const active = getActiveLog(user);
      if (active) {
        statusBox.classList.remove('off');
        statusBox.innerHTML = '✅ Bạn đang trong ca làm (bắt đầu lúc ' + hm(toDateObj(active.checkInTime)) + ')';
        checkInBtn.style.display = 'none';
        checkOutBtn.style.display = 'inline-flex';
        noteWrap.style.display = 'block';
      } else {
        statusBox.classList.add('off');
        statusBox.innerHTML = '❌ Bạn chưa check-in';
        checkInBtn.style.display = 'inline-flex';
        checkOutBtn.style.display = 'none';
        noteWrap.style.display = 'none';
      }
    }

    function renderStats() {
      const { todayHours, weekHours, monthHours, monthEarnings } = computeStats();
      document.getElementById('todayHours').textContent = todayHours ? todayHours.toFixed(2) + ' giờ' : '0 giờ';
      document.getElementById('weekMonthHours').textContent = (weekHours.toFixed(2) + 'h / ' + monthHours.toFixed(2) + 'h');
      document.getElementById('monthEarnings').textContent = fmtMoney(monthEarnings);

      // Target
      const user = getUser();
      const target = parseVNInt(user?.settings?.targetIncome || 0);
      const pct = target > 0 ? Math.min(100, Math.round((monthEarnings / target) * 100)) : 0;
      document.getElementById('targetProgress').style.width = pct + '%';
      document.getElementById('targetLabel').textContent = (target > 0)
        ? (pct + '% đã đạt được — ' + fmtMoney(monthEarnings) + ' / ' + fmtMoney(target))
        : 'Chưa đặt mục tiêu';
      document.getElementById('targetIncome').value = target ? target : '';
    }

    function renderRecent() {
      const user = getUser();
      const wrap = document.getElementById('recentLogs');
      wrap.innerHTML = '';

      const logs = (user?.timeLogs || []).slice(0, 8);
      if (logs.length === 0) {
        wrap.innerHTML = '<div class="muted">Chưa có ca nào</div>';
        return;
      }

      const allowEdit = !!(user?.settings?.allowEdit);
      logs.forEach(x => {
        const div = document.createElement('div');
        div.className = 'stat';
        const active = x.checkInTime && !x.checkOutTime;

        const title = active
          ? 'Đang làm — bắt đầu ' + displayDT(x.checkInTime)
          : displayDT(x.checkInTime) + ' → ' + (x.checkOutTime ? displayDT(x.checkOutTime) : '—');

        const hours = x.checkOutTime ? hoursBetween(x.checkInTime, x.checkOutTime) : hoursBetween(x.checkInTime, nowISO());
        const pay = x.checkOutTime ? (x.earnings || 0) : Math.round(hours * (user.hourlyWage || 0));

        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:10px; align-items: center;">
            <div>
              <div style="font-weight:700;">${title}</div>
              <div class="muted">${x.note ? ('Ghi chú: ' + x.note.replace(/</g,'&lt;')) : ''}</div>
              <div class="muted">⏱ ${hours.toFixed(2)} giờ — 💰 ${fmtMoney(pay)}</div>
            </div>
            <div class="table-actions">
              ${allowEdit ? `<button class="btn btn-outline" data-edit="${x.id}">Sửa</button>` : ''}
              <button class="btn btn-red" data-del="${x.id}">Xóa</button>
            </div>
          </div>
          ${allowEdit ? `
          <div class="row" data-edit-form="${x.id}" style="margin-top:10px; display:none;">
            <div class="field">
              <label>Ngày</label>
              <input type="date" class="input" data-edit-date="${x.id}"/>
            </div>
            <div class="field">
              <label>Bắt đầu</label>
              <input type="time" class="input" step="60" data-edit-start="${x.id}"/>
            </div>
            <div class="field">
              <label>Kết thúc</label>
              <input type="time" class="input" step="60" data-edit-end="${x.id}"/>
            </div>
            <div class="field" style="flex-basis:100%;">
              <label>Ghi chú</label>
              <input class="input" placeholder="Ghi chú" data-edit-note="${x.id}"/>
            </div>
            <button class="btn" data-edit-save="${x.id}">Lưu</button>
            <button class="btn btn-muted" data-edit-cancel="${x.id}">Hủy</button>
          </div>` : ''}
        `;
        wrap.appendChild(div);

        // Bind buttons
        div.querySelectorAll('button[data-del]').forEach(btn => {
          btn.addEventListener('click', () => deleteLog(btn.getAttribute('data-del')));
        });
        if (allowEdit) {
          const editBtn = div.querySelector(`button[data-edit="${x.id}"]`);
          const form = div.querySelector(`[data-edit-form="${x.id}"]`);
          const dateI = div.querySelector(`[data-edit-date="${x.id}"]`);
          const startI = div.querySelector(`[data-edit-start="${x.id}"]`);
          const endI = div.querySelector(`[data-edit-end="${x.id}"]`);
          const noteI = div.querySelector(`[data-edit-note="${x.id}"]`);
          const saveBtn = div.querySelector(`[data-edit-save="${x.id}"]`);
          const cancelBtn = div.querySelector(`[data-edit-cancel="${x.id}"]`);

          if (editBtn) {
            editBtn.addEventListener('click', () => {
              // Prefill
              const s = toDateObj(x.checkInTime);
              dateI.value = ymd(s);
              startI.value = hm(s);
              endI.value = x.checkOutTime ? hm(toDateObj(x.checkOutTime)) : '';
              noteI.value = x.note || '';
              form.style.display = form.style.display === 'none' ? 'flex' : 'none';
            });
          }
          if (saveBtn) {
            saveBtn.addEventListener('click', () => {
              const d = dateI.value;
              const st = startI.value;
              const en = endI.value;
              const note = noteI.value.trim();
              if (!d || !st) { showToast('Ngày và giờ bắt đầu là bắt buộc'); return; }
              const sISO = new Date(d + 'T' + st + ':00').toISOString();
              const eISO = en ? new Date(d + 'T' + en + ':00').toISOString() : null;
              if (eISO && hoursBetween(sISO, eISO) <= 0) { showToast('Giờ kết thúc phải sau giờ bắt đầu'); return; }
              updateLog(x.id, sISO, eISO, note);
            });
          }
          if (cancelBtn) {
            cancelBtn.addEventListener('click', () => { form.style.display = 'none'; });
          }
        }
      });
    }

    // ====== Reminder ======
    let reminderTimer = null;
    function updateReminder() {
      const bar = document.getElementById('reminderBar');
      const user = getUser();
      if (!user) { bar.style.display = 'none'; return; }

      const enabled = !!(user.settings?.reminders);
      if (!enabled) { bar.style.display = 'none'; return; }

      const active = getActiveLog(user);
      if (active) {
        const h = hoursBetween(active.checkInTime, nowISO());
        if (h >= 8) {
          bar.textContent = 'Bạn đã làm ' + h.toFixed(2) + ' giờ — nhớ CHECK-OUT nếu đã xong nhé!';
          bar.style.display = 'block';
        } else {
          bar.style.display = 'none';
        }
      } else {
        // not active: gentle nudge late afternoon
        const now = new Date();
        const hour = now.getHours();
        if (hour >= 17 && hour <= 20) {
          bar.textContent = 'Bạn chưa check-in hôm nay? Hãy kiểm tra lại nhé.';
          bar.style.display = 'block';
        } else {
          bar.style.display = 'none';
        }
      }
    }

    // ====== Export / Backup ======
    function exportCSV() {
      const user = getUser();
      if (!user) return;
      const m = parseInt(document.getElementById('reportMonth').value, 10);
      const year = parseInt(document.getElementById('reportYear').value, 10);
      const start = new Date(year, m-1, 1);
      const end = new Date(year, m, 1);
      const logs = (user.timeLogs || []).filter(x => {
        const ci = toDateObj(x.checkInTime);
        return ci >= start && ci < end && x.checkOutTime;
      }).sort((a,b) => toDateObj(a.checkInTime) - toDateObj(b.checkInTime));

      const rows = [['Ngày','Check-in','Check-out','Số giờ','Lương','Ghi chú']];
      logs.forEach(x => {
        const h = hoursBetween(x.checkInTime, x.checkOutTime);
        rows.push([
          displayDate(x.checkInTime),
          displayDT(x.checkInTime),
          displayDT(x.checkOutTime),
          h.toFixed(2),
          (x.earnings || 0),
          (x.note || '').replace(/"/g,'""')
        ]);
      });

      const csv = rows.map(r => r.map(v => `"${String(v)}"`).join(',')).join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `bao_cao_${user ? Object.keys(appData.users).indexOf(appData.currentUser) : 'user'}_${year}_${m}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function backupJSON() {
      const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `chamcong_backup.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Đã xuất backup JSON');
    }

    function restoreJSON(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          // Basic sanity
          if (!obj || typeof obj !== 'object' || !('users' in obj)) throw new Error('invalid');
          appData = obj;
          saveData();
          showToast('Đã khôi phục dữ liệu');
          updateUI();
        } catch {
          showToast('File JSON không hợp lệ');
        }
      };
      reader.readAsText(file);
    }

    // ====== Edit dialog via prompt (simple) ======
    function openEditPrompt(logId) {
      const user = getUser();
      if (!user?.settings?.allowEdit) { showToast('Chỉnh sửa đang tắt'); return; }
      const rec = user.timeLogs.find(x => x.id === logId);
      if (!rec) return;

      const s = toDateObj(rec.checkInTime);
      const e = rec.checkOutTime ? toDateObj(rec.checkOutTime) : null;
      const dStr = prompt('Ngày (YYYY-MM-DD)', ymd(s));
      if (!dStr) return;
      const sStr = prompt('Bắt đầu (HH:MM)', hm(s));
      if (!sStr) return;
      const eStr = prompt('Kết thúc (HH:MM) — bỏ trống nếu chưa', e ? hm(e) : '');
      const note = prompt('Ghi chú', rec.note || '') || '';

      const sISO = new Date(dStr + 'T' + sStr + ':00').toISOString();
      const eISO = eStr ? new Date(dStr + 'T' + eStr + ':00').toISOString() : null;
      if (eISO && hoursBetween(sISO, eISO) <= 0) { showToast('Giờ kết thúc phải sau giờ bắt đầu'); return; }
      updateLog(rec.id, sISO, eISO, note);
    }

    // ====== UI Update ======
    function updateUI() {
      const user = getUser();
      if (!appData.currentUser || !user) {
        showView('loginView');
        return;
      }
      showView('appView');

      // Greeting
      document.getElementById('greeting').textContent = 'Xin chào, ' + appData.currentUser + '!';

      // Settings
      const wage = user.hourlyWage || 0;
      document.getElementById('currentWage').textContent = fmtMoney(wage) + '/giờ';
      document.getElementById('newWage').value = '';

      // Settings toggles
      if (!user.settings) user.settings = { reminders: true, allowEdit: true, dark: false, targetIncome: 0 };
      document.getElementById('reminderToggle').checked = !!user.settings.reminders;
      document.getElementById('editToggle').checked = !!user.settings.allowEdit;
      document.getElementById('darkToggle').checked = !!user.settings.dark;
      applyTheme(!!user.settings.dark);

      // Dashboard
      renderStatus();
      renderStats();
      renderRecent();

      // Report selectors
      populateMonthYearSelectors();
      if (activeTab === 'reportTab') generateReport();

      // Reminder
      updateReminder();
    }

    function populateMonthYearSelectors() {
      const monthSel = document.getElementById('reportMonth');
      const yearSel = document.getElementById('reportYear');

      if (!monthSel.dataset.filled) {
        monthSel.innerHTML = '';
        for (let m = 1; m <= 12; m++) {
          const opt = document.createElement('option');
          opt.value = m; opt.textContent = m;
          monthSel.appendChild(opt);
        }
        monthSel.dataset.filled = '1';
      }

      const user = getUser();
      const years = new Set();
      const now = new Date();
      years.add(now.getFullYear());
      (user?.timeLogs || []).forEach(x => {
        years.add(toDateObj(x.checkInTime).getFullYear());
      });
      
      yearSel.innerHTML = '';
      Array.from(years).sort((a,b)=>a-b).forEach(y => {
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        yearSel.appendChild(opt);
      });
        yearSel.dataset.filled = '1';   
      // Default to current month/year
      const cur = new Date();
      monthSel.value = cur.getMonth() + 1;
      yearSel.value = cur.getFullYear();
    }

    // ====== Theme ======
    function applyTheme(dark) {
      document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
    }

    // ====== Init ======
    document.addEventListener('DOMContentLoaded', () => {
      loadData();

      // Events: Auth
      document.getElementById('loginBtn').addEventListener('click', handleLoginRegister);
      document.getElementById('logoutBtn').addEventListener('click', logout);

      // Events: Tabs
      document.getElementById('tabDashboardBtn').addEventListener('click', () => showTab('dashboardTab'));
      document.getElementById('tabReportBtn').addEventListener('click', () => showTab('reportTab'));
      document.getElementById('tabSettingsBtn').addEventListener('click', () => showTab('settingsTab'));

      // Events: Core
      document.getElementById('checkInBtn').addEventListener('click', checkIn);
      document.getElementById('checkOutBtn').addEventListener('click', checkOut);
      document.getElementById('addManualBtn').addEventListener('click', addManualLog);
      document.getElementById('saveWageBtn').addEventListener('click', updateWage);

      // Target income
      document.getElementById('saveTargetBtn').addEventListener('click', () => {
        const user = getUser(); if (!user) return;
        const v = parseVNInt(document.getElementById('targetIncome').value);
        user.settings.targetIncome = v > 0 ? v : 0;
        saveData();
        showToast('Đã lưu mục tiêu');
        renderStats();
      });

      // Report controls
      document.getElementById('refreshReportBtn').addEventListener('click', generateReport);
      document.getElementById('reportMonth').addEventListener('change', generateReport);
      document.getElementById('reportYear').addEventListener('change', generateReport);
      document.getElementById('exportCsvBtn').addEventListener('click', exportCSV);

      // Backup/restore
      document.getElementById('backupBtn').addEventListener('click', backupJSON);
      document.getElementById('restoreInput').addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (f) restoreJSON(f);
        e.target.value = '';
      });

      // Settings toggles
      document.getElementById('reminderToggle').addEventListener('change', (e) => {
        const user = getUser(); if (!user) return;
        user.settings.reminders = !!e.target.checked;
        saveData();
        updateReminder();
      });
      document.getElementById('editToggle').addEventListener('change', (e) => {
        const user = getUser(); if (!user) return;
        user.settings.allowEdit = !!e.target.checked;
        saveData();
        renderRecent();
      });
      document.getElementById('darkToggle').addEventListener('change', (e) => {
        const user = getUser(); if (!user) return;
        user.settings.dark = !!e.target.checked;
        applyTheme(user.settings.dark);
        saveData();
        // Re-render chart to adjust colors
        if (activeTab === 'reportTab') generateReport();
      });

      // Reminder interval
      reminderTimer = setInterval(() => {
        const user = getUser();
        if (!user?.settings?.reminders) return;
        updateReminder();
      }, 60 * 1000);

      updateUI();
    });
  </script>
</body>
</html>
