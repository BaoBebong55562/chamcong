<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Chấm Công Offline</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login View Styles */
        #loginView {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #667eea;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="time"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        /* App View Styles */
        #appView {
            min-height: 100vh;
        }

        .navbar {
            background: white;
            padding: 15px 0;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .navbar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
        }

        .welcome-text {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn:hover, .nav-btn.active {
            background: #667eea;
            color: white;
        }

        .logout-btn {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* Tab Content Styles */
        .tab-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .checkin-section {
            text-align: center;
            margin: 30px 0;
        }

        .checkin-btn {
            font-size: 20px;
            padding: 20px 40px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }

        .checkin-btn.checkin {
            background: #28a745;
            color: white;
        }

        .checkin-btn.checkout {
            background: #dc3545;
            color: white;
        }

        .manual-entry {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .manual-entry h3 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .total-row {
            background: #667eea !important;
            color: white;
            font-weight: bold;
        }

        .total-row:hover {
            background: #667eea !important;
        }

        /* Report Filters */
        .report-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }

        .filter-group {
            flex: 1;
        }

        /* Settings Styles */
        .settings-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .current-wage {
            font-size: 18px;
            margin-bottom: 20px;
            color: #667eea;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .navbar {
                margin-bottom: 15px;
            }

            .navbar-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 0 20px;
            }

            .nav-buttons {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }

            .nav-btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            .tab-content {
                padding: 20px 15px;
            }

            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 20px;
            }

            .checkin-btn {
                font-size: 18px;
                padding: 18px 35px;
                width: 100%;
                max-width: 300px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .report-filters {
                flex-direction: column;
                gap: 15px;
            }

            .backup-buttons {
                flex-direction: column;
            }

            .btn-group {
                flex-direction: column;
            }

            .chart-container {
                padding: 15px;
                overflow-x: auto;
            }

            #hoursChart {
                min-width: 300px;
            }

            .table-container {
                font-size: 14px;
            }

            th, td {
                padding: 8px 6px;
            }

            .notification-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .notification {
                padding: 14px 16px;
                margin-bottom: 8px;
            }

            .notification-title {
                font-size: 15px;
            }

            .notification-message {
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }

            .welcome-text {
                font-size: 16px;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .logout-btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .checkin-btn {
                font-size: 16px;
                padding: 16px 30px;
            }

            .stat-value {
                font-size: 18px;
            }

            .stat-label {
                font-size: 12px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Status Section */
        .status-section {
            margin: 20px 0;
        }

        .status-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .status-card.working {
            border-color: #28a745;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .status-icon {
            font-size: 24px;
        }

        .status-text {
            font-size: 18px;
            font-weight: 600;
        }

        /* Note Section */
        .note-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Chart Section */
        .chart-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            overflow-x: auto;
        }

        /* Goal Progress */
        .goal-progress {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }

        /* Backup Buttons */
        .backup-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .backup-buttons .btn {
            flex: 1;
            min-width: 150px;
        }

        /* Striped Table */
        tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        tbody tr:nth-child(even):hover {
            background: #e9ecef;
        }

        /* Improved buttons */
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-group .btn {
            flex: 1;
            min-width: 120px;
        }

        /* Notification Banner System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            width: 100%;
        }

        .notification {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-left: 5px solid #667eea;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(450px);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success {
            border-left-color: #28a745;
        }

        .notification.error {
            border-left-color: #dc3545;
        }

        .notification.info {
            border-left-color: #17a2b8;
        }

        .notification.warning {
            border-left-color: #ffc107;
        }

        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            color: #333;
        }

        .notification-message {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .notification-close:hover {
            background: #f0f0f0;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Login View -->
    <div id="loginView">
        <div class="login-card">
            <h1>🕐 Ứng Dụng Chấm Công</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Tên đăng nhập:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Mật khẩu:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn">Đăng Nhập / Đăng Ký</button>
            </form>
        </div>
    </div>

    <!-- App View -->
    <div id="appView" class="hidden">
        <div class="container">
            <!-- Navbar -->
            <div class="navbar">
                <div class="navbar-content">
                    <div class="welcome-text" id="welcomeText">Xin chào!</div>
                    <div class="nav-buttons">
                        <button class="nav-btn active" onclick="showTab('dashboardTab')">Dashboard</button>
                        <button class="nav-btn" onclick="showTab('reportTab')">Báo Cáo</button>
                        <button class="nav-btn" onclick="showTab('settingsTab')">Cài Đặt</button>
                        <button class="logout-btn" onclick="logout()">Đăng Xuất</button>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content">
                <h2>📊 Dashboard</h2>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="todayHours">0 giờ</div>
                        <div class="stat-label">⏰ Giờ làm hôm nay</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weeklyHours">0 giờ</div>
                        <div class="stat-label">📅 Tuần này</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="monthlyHours">0 giờ</div>
                        <div class="stat-label">📊 Tháng này</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="monthlyEarnings">0 VNĐ</div>
                        <div class="stat-label">💰 Thu nhập tháng này</div>
                    </div>
                </div>

                <div class="status-section">
                    <div class="status-card" id="statusCard">
                        <div class="status-icon">❌</div>
                        <div class="status-text" id="statusText">Bạn chưa check-in</div>
                    </div>
                </div>

                <div class="checkin-section">
                    <button id="checkinBtn" class="checkin-btn checkin" onclick="handleCheckInOut()">
                        CHECK-IN
                    </button>
                    
                    <!-- Note input for checkout -->
                    <div id="noteSection" class="note-section hidden">
                        <div class="form-group">
                            <label for="workNote">Ghi chú công việc hôm nay:</label>
                            <textarea id="workNote" placeholder="Mô tả công việc đã hoàn thành..." rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="chart-section">
                    <h3>📈 Biểu đồ giờ làm trong tháng</h3>
                    <div class="chart-container">
                        <canvas id="hoursChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <div class="manual-entry">
                    <h3>➕ Thêm ca làm thủ công</h3>
                    <form id="manualEntryForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="manualDate">Ngày:</label>
                                <input type="date" id="manualDate" required>
                            </div>
                            <div class="form-group">
                                <label for="manualStartTime">Giờ bắt đầu:</label>
                                <input type="time" id="manualStartTime" required>
                            </div>
                            <div class="form-group">
                                <label for="manualEndTime">Giờ kết thúc:</label>
                                <input type="time" id="manualEndTime" required>
                            </div>
                        </div>
                        <button type="submit" class="btn">Thêm ca làm</button>
                    </form>
                </div>
            </div>

            <!-- Report Tab -->
            <div id="reportTab" class="tab-content hidden">
                <h2>📈 Báo Cáo Lương</h2>
                
                <div class="report-filters">
                    <div class="filter-group">
                        <label for="reportMonth">Tháng:</label>
                        <select id="reportMonth">
                            <option value="1">Tháng 1</option>
                            <option value="2">Tháng 2</option>
                            <option value="3">Tháng 3</option>
                            <option value="4">Tháng 4</option>
                            <option value="5">Tháng 5</option>
                            <option value="6">Tháng 6</option>
                            <option value="7">Tháng 7</option>
                            <option value="8">Tháng 8</option>
                            <option value="9">Tháng 9</option>
                            <option value="10">Tháng 10</option>
                            <option value="11">Tháng 11</option>
                            <option value="12">Tháng 12</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="reportYear">Năm:</label>
                        <select id="reportYear"></select>
                    </div>
                    <button class="btn" onclick="generateReport()">Xem báo cáo</button>
                    <button class="btn btn-success" onclick="exportToCSV()">📊 Xuất CSV</button>
                </div>

                <div class="table-container">
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>Ngày</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Số giờ làm</th>
                                <th>Lương</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content hidden">
                <h2>⚙️ Cài Đặt</h2>
                
                <div class="settings-section">
                    <div class="current-wage" id="currentWageDisplay">Mức lương hiện tại: 0 VNĐ/giờ</div>
                    
                    <form id="wageForm">
                        <div class="form-group">
                            <label for="newWage">Mức lương mới theo giờ (VNĐ):</label>
                            <input type="number" id="newWage" min="0" step="1000" placeholder="Nhập mức lương mới theo giờ" required>
                        </div>
                        <button type="submit" class="btn">Lưu thay đổi</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h3>🎯 Mục tiêu thu nhập tháng</h3>
                    <div class="current-wage" id="currentGoalDisplay">Mục tiêu hiện tại: 0 VNĐ/tháng</div>
                    
                    <form id="goalForm">
                        <div class="form-group">
                            <label for="monthlyGoal">Mục tiêu thu nhập tháng (VNĐ):</label>
                            <input type="number" id="monthlyGoal" min="0" step="100000" placeholder="Ví dụ: 1600000" required>
                        </div>
                        <button type="submit" class="btn">Đặt mục tiêu</button>
                    </form>
                    
                    <div class="goal-progress" id="goalProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">0% hoàn thành mục tiêu</div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>💾 Sao lưu & Khôi phục dữ liệu</h3>
                    <div class="backup-buttons">
                        <button class="btn btn-success" onclick="exportBackup()">📤 Xuất backup</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">📥 Nhập backup</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackup(event)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <script>
        // Global variables
        let appData = {
            currentUser: null,
            users: {}
        };

        let currentChart = null;

        // Notification System
        function showNotification(type, title, message, duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                info: 'ℹ️',
                warning: '⚠️'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">${icons[type] || 'ℹ️'}</div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="closeNotification(this)">×</button>
            `;
            
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                closeNotification(notification.querySelector('.notification-close'));
            }, duration);
        }

        function closeNotification(closeBtn) {
            const notification = closeBtn.closest('.notification');
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 400);
        }

        // Data management functions
        function loadData() {
            const stored = localStorage.getItem('chamCongApp');
            if (stored) {
                appData = JSON.parse(stored);
            }
        }

        function saveData() {
            localStorage.setItem('chamCongApp', JSON.stringify(appData));
        }

        // UI management functions
        function showView(viewId) {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('appView').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        function showTab(tabId) {
            // Hide all tabs
            document.getElementById('dashboardTab').classList.add('hidden');
            document.getElementById('reportTab').classList.add('hidden');
            document.getElementById('settingsTab').classList.add('hidden');
            
            // Show selected tab
            document.getElementById(tabId).classList.remove('hidden');
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update content based on tab
            if (tabId === 'dashboardTab') {
                updateDashboard();
            } else if (tabId === 'reportTab') {
                initializeReportFilters();
            } else if (tabId === 'settingsTab') {
                updateSettingsDisplay();
            }
        }

        function updateUI() {
            if (appData.currentUser) {
                document.getElementById('welcomeText').textContent = `Xin chào, ${appData.currentUser}!`;
                updateDashboard();
                updateSettingsDisplay();
                showView('appView');
            } else {
                showView('loginView');
            }
        }

        // Authentication functions
        function handleLoginRegister() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showNotification('warning', 'Thiếu thông tin', 'Vui lòng nhập đầy đủ tên đăng nhập và mật khẩu!');
                return;
            }
            
            if (!appData.users[username]) {
                // Create new user
                appData.users[username] = {
                    password: password,
                    hourlyWage: 25000,
                    monthlyGoal: 1600000,
                    timeLogs: []
                };
                showNotification('success', 'Đăng ký thành công!', `Chào mừng ${username} đến với ứng dụng chấm công!`);
            } else {
                // Check existing user
                if (appData.users[username].password !== password) {
                    showNotification('error', 'Đăng nhập thất bại', 'Mật khẩu không đúng, vui lòng thử lại!');
                    return;
                }
                showNotification('success', 'Đăng nhập thành công!', `Chào mừng ${username} quay trở lại!`);
            }
            
            appData.currentUser = username;
            saveData();
            updateUI();
            
            // Clear form
            document.getElementById('loginForm').reset();
        }

        function logout() {
            appData.currentUser = null;
            saveData();
            updateUI();
        }

        // Dashboard functions
        function updateDashboard() {
            if (!appData.currentUser) return;
            
            const user = appData.users[appData.currentUser];
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Calculate stats
            let todayHours = 0;
            let weeklyHours = 0;
            let monthlyHours = 0;
            let monthlyEarnings = 0;
            
            // Get start of week (Monday)
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (today.getDay() || 7) + 1);
            
            user.timeLogs.forEach(log => {
                const logDate = new Date(log.checkInTime);
                const logDay = new Date(logDate.getFullYear(), logDate.getMonth(), logDate.getDate());
                
                if (log.checkOutTime) {
                    const hours = (new Date(log.checkOutTime) - new Date(log.checkInTime)) / (1000 * 60 * 60);
                    
                    // Today's hours
                    if (logDay.getTime() === today.getTime()) {
                        todayHours += hours;
                    }
                    
                    // Weekly hours
                    if (logDay >= startOfWeek && logDay <= today) {
                        weeklyHours += hours;
                    }
                    
                    // Monthly stats
                    if (logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear) {
                        monthlyHours += hours;
                        monthlyEarnings += log.earnings || 0;
                    }
                }
            });
            
            // Update display
            document.getElementById('todayHours').textContent = todayHours.toFixed(1) + ' giờ';
            document.getElementById('weeklyHours').textContent = weeklyHours.toFixed(1) + ' giờ';
            document.getElementById('monthlyHours').textContent = monthlyHours.toFixed(1) + ' giờ';
            document.getElementById('monthlyEarnings').textContent = formatCurrency(monthlyEarnings);
            
            // Update status
            const activeLog = user.timeLogs.find(log => !log.checkOutTime);
            const checkinBtn = document.getElementById('checkinBtn');
            const statusCard = document.getElementById('statusCard');
            const statusText = document.getElementById('statusText');
            const noteSection = document.getElementById('noteSection');
            
            if (activeLog) {
                checkinBtn.textContent = 'CHECK-OUT';
                checkinBtn.className = 'checkin-btn checkout';
                statusCard.className = 'status-card working';
                statusCard.querySelector('.status-icon').textContent = '✅';
                const startTime = new Date(activeLog.checkInTime).toLocaleTimeString('vi-VN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                statusText.textContent = `Bạn đang trong ca làm việc (bắt đầu lúc ${startTime})`;
                noteSection.classList.remove('hidden');
            } else {
                checkinBtn.textContent = 'CHECK-IN';
                checkinBtn.className = 'checkin-btn checkin';
                statusCard.className = 'status-card';
                statusCard.querySelector('.status-icon').textContent = '❌';
                statusText.textContent = 'Bạn chưa check-in';
                noteSection.classList.add('hidden');
            }
            
            // Set today's date for manual entry
            document.getElementById('manualDate').value = now.toISOString().split('T')[0];
            
            // Update chart
            updateChart();
        }

        function handleCheckInOut() {
            if (!appData.currentUser) return;
            
            const user = appData.users[appData.currentUser];
            const now = new Date();
            const activeLog = user.timeLogs.find(log => !log.checkOutTime);
            
            if (activeLog) {
                // Check-out
                const workNote = document.getElementById('workNote').value.trim();
                activeLog.checkOutTime = now.toISOString();
                activeLog.note = workNote;
                const hours = (now - new Date(activeLog.checkInTime)) / (1000 * 60 * 60);
                activeLog.earnings = Math.round(hours * user.hourlyWage);
                showNotification('success', 'Check-out thành công!', 
                    `Bạn đã làm ${hours.toFixed(1)} giờ và kiếm được ${formatCurrency(activeLog.earnings)}`);
                document.getElementById('workNote').value = '';
            } else {
                // Check-in
                const newLog = {
                    id: now.getTime().toString(),
                    checkInTime: now.toISOString(),
                    checkOutTime: null,
                    earnings: 0,
                    note: ''
                };
                user.timeLogs.push(newLog);
                showNotification('success', 'Check-in thành công!', 
                    `Bắt đầu ca làm việc lúc ${formatTime(now)}`);
            }
            
            saveData();
            updateDashboard();
        }

        function handleManualEntry() {
            const date = document.getElementById('manualDate').value;
            const startTime = document.getElementById('manualStartTime').value;
            const endTime = document.getElementById('manualEndTime').value;
            
            if (!date || !startTime || !endTime) {
                showNotification('error', 'Thiếu thông tin', 'Vui lòng nhập đầy đủ ngày, giờ bắt đầu và giờ kết thúc!');
                return;
            }
            
            const startDateTime = new Date(`${date}T${startTime}`);
            const endDateTime = new Date(`${date}T${endTime}`);
            
            if (endDateTime <= startDateTime) {
                showNotification('error', 'Dữ liệu không hợp lệ', 'Giờ kết thúc phải sau giờ bắt đầu!');
                return;
            }
            
            const user = appData.users[appData.currentUser];
            const hours = (endDateTime - startDateTime) / (1000 * 60 * 60);
            const earnings = Math.round(hours * user.hourlyWage);
            
            const newLog = {
                id: Date.now().toString(),
                checkInTime: startDateTime.toISOString(),
                checkOutTime: endDateTime.toISOString(),
                earnings: earnings,
                note: 'Ca làm thủ công'
            };
            
            user.timeLogs.push(newLog);
            saveData();
            updateDashboard();
            
            showNotification('success', 'Thêm ca làm thành công!', 
                `Đã thêm ca làm ${hours.toFixed(1)} giờ, thu nhập ${formatCurrency(earnings)}`);
            document.getElementById('manualEntryForm').reset();
            document.getElementById('manualDate').value = new Date().toISOString().split('T')[0];
        }

        // Report functions
        function initializeReportFilters() {
            const yearSelect = document.getElementById('reportYear');
            const currentYear = new Date().getFullYear();
            
            // Clear existing options
            yearSelect.innerHTML = '';
            
            // Add years (current year and 2 years back)
            for (let year = currentYear; year >= currentYear - 2; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
            
            // Set current month
            document.getElementById('reportMonth').value = new Date().getMonth() + 1;
        }

        function generateReport() {
            if (!appData.currentUser) return;
            
            const month = parseInt(document.getElementById('reportMonth').value) - 1;
            const year = parseInt(document.getElementById('reportYear').value);
            const user = appData.users[appData.currentUser];
            
            const filteredLogs = user.timeLogs.filter(log => {
                const logDate = new Date(log.checkInTime);
                return logDate.getMonth() === month && logDate.getFullYear() === year && log.checkOutTime;
            });
            
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            
            let totalHours = 0;
            let totalEarnings = 0;
            
            filteredLogs.forEach(log => {
                const checkInDate = new Date(log.checkInTime);
                const checkOutDate = new Date(log.checkOutTime);
                const hours = (checkOutDate - checkInDate) / (1000 * 60 * 60);
                
                totalHours += hours;
                totalEarnings += log.earnings;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(checkInDate)}</td>
                    <td>${formatTime(checkInDate)}</td>
                    <td>${formatTime(checkOutDate)}</td>
                    <td>${hours.toFixed(1)} giờ</td>
                    <td>${formatCurrency(log.earnings)}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="3"><strong>Tổng cộng</strong></td>
                <td><strong>${totalHours.toFixed(1)} giờ</strong></td>
                <td><strong>${formatCurrency(totalEarnings)}</strong></td>
            `;
            tbody.appendChild(totalRow);
        }

        // Chart functions
        function updateChart() {
            const canvas = document.getElementById('hoursChart');
            const ctx = canvas.getContext('2d');
            
            if (!appData.currentUser) return;
            
            const user = appData.users[appData.currentUser];
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Get days in current month
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const dailyHours = new Array(daysInMonth).fill(0);
            
            // Calculate daily hours
            user.timeLogs.forEach(log => {
                const logDate = new Date(log.checkInTime);
                if (logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear && log.checkOutTime) {
                    const day = logDate.getDate() - 1;
                    const hours = (new Date(log.checkOutTime) - new Date(log.checkInTime)) / (1000 * 60 * 60);
                    dailyHours[day] += hours;
                }
            });
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Chart settings
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const barWidth = chartWidth / daysInMonth;
            const maxHours = Math.max(...dailyHours, 8);
            
            // Draw bars
            ctx.fillStyle = '#667eea';
            dailyHours.forEach((hours, index) => {
                const barHeight = (hours / maxHours) * chartHeight;
                const x = padding + index * barWidth;
                const y = padding + chartHeight - barHeight;
                
                ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
                
                // Draw day labels
                if (index % 5 === 0 || index === daysInMonth - 1) {
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(index + 1, x + barWidth / 2, canvas.height - 10);
                    ctx.fillStyle = '#667eea';
                }
            });
            
            // Draw axes
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + chartHeight);
            ctx.lineTo(padding + chartWidth, padding + chartHeight);
            ctx.stroke();
        }

        // Export functions
        function exportToCSV() {
            if (!appData.currentUser) return;
            
            const month = parseInt(document.getElementById('reportMonth').value) - 1;
            const year = parseInt(document.getElementById('reportYear').value);
            const user = appData.users[appData.currentUser];
            
            const filteredLogs = user.timeLogs.filter(log => {
                const logDate = new Date(log.checkInTime);
                return logDate.getMonth() === month && logDate.getFullYear() === year && log.checkOutTime;
            });
            
            let csvContent = 'Ngày,Check-in,Check-out,Số giờ làm,Lương,Ghi chú\n';
            
            filteredLogs.forEach(log => {
                const checkInDate = new Date(log.checkInTime);
                const checkOutDate = new Date(log.checkOutTime);
                const hours = (checkOutDate - checkInDate) / (1000 * 60 * 60);
                
                csvContent += `${formatDate(checkInDate)},${formatTime(checkInDate)},${formatTime(checkOutDate)},${hours.toFixed(1)},${log.earnings},${log.note || ''}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `bao-cao-${month + 1}-${year}.csv`;
            link.click();
            
            showNotification('success', 'Xuất báo cáo thành công!', 
                `File CSV tháng ${month + 1}/${year} đã được tải xuống`);
        }

        function exportBackup() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `cham-cong-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('success', 'Xuất backup thành công!', 
                'File sao lưu đã được tải xuống. Hãy lưu trữ an toàn!');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (confirm('Bạn có chắc muốn khôi phục dữ liệu? Dữ liệu hiện tại sẽ bị ghi đè.')) {
                        appData = importedData;
                        saveData();
                        updateUI();
                        showNotification('success', 'Khôi phục thành công!', 
                            'Dữ liệu đã được khôi phục từ file backup');
                    }
                } catch (error) {
                    showNotification('error', 'Lỗi khôi phục', 
                        'File backup không hợp lệ hoặc bị hỏng!');
                }
            };
            reader.readAsText(file);
        }

        // Settings functions
        function updateSettingsDisplay() {
            if (!appData.currentUser) return;
            
            const user = appData.users[appData.currentUser];
            document.getElementById('currentWageDisplay').textContent = 
                `Mức lương hiện tại: ${formatCurrency(user.hourlyWage)}/giờ`;
            
            // Update goal display
            const monthlyGoal = user.monthlyGoal || 1600000;
            document.getElementById('currentGoalDisplay').textContent = 
                `Mục tiêu hiện tại: ${formatCurrency(monthlyGoal)}/tháng`;
            
            // Calculate progress
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let monthlyEarnings = 0;
            user.timeLogs.forEach(log => {
                const logDate = new Date(log.checkInTime);
                if (logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear) {
                    monthlyEarnings += log.earnings || 0;
                }
            });
            
            const progress = Math.min((monthlyEarnings / monthlyGoal) * 100, 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `${progress.toFixed(1)}% hoàn thành mục tiêu (${formatCurrency(monthlyEarnings)}/${formatCurrency(monthlyGoal)})`;
        }

        function handleWageUpdate() {
            const newWage = parseInt(document.getElementById('newWage').value);
            
            if (!newWage || newWage < 0) {
                showNotification('error', 'Dữ liệu không hợp lệ', 'Vui lòng nhập mức lương hợp lệ (lớn hơn 0)!');
                return;
            }
            
            appData.users[appData.currentUser].hourlyWage = newWage;
            saveData();
            updateSettingsDisplay();
            updateDashboard();
            
            showNotification('success', 'Cập nhật lương thành công!', 
                `Mức lương mới: ${formatCurrency(newWage)}/giờ`);
            document.getElementById('wageForm').reset();
        }

        function handleGoalUpdate() {
            const newGoal = parseInt(document.getElementById('monthlyGoal').value);
            
            if (!newGoal || newGoal < 0) {
                showNotification('error', 'Dữ liệu không hợp lệ', 'Vui lòng nhập mục tiêu hợp lệ (lớn hơn 0)!');
                return;
            }
            
            appData.users[appData.currentUser].monthlyGoal = newGoal;
            saveData();
            updateSettingsDisplay();
            
            showNotification('success', 'Đặt mục tiêu thành công!', 
                `Mục tiêu mới: ${formatCurrency(newGoal)}/tháng`);
            document.getElementById('goalForm').reset();
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function formatDate(date) {
            return date.toLocaleDateString('vi-VN');
        }

        function formatTime(date) {
            return date.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleLoginRegister();
        });

        document.getElementById('manualEntryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleManualEntry();
        });

        document.getElementById('wageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleWageUpdate();
        });

        document.getElementById('goalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleGoalUpdate();
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateUI();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9832c56f33106e55',t:'MTc1ODU1NDI2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
